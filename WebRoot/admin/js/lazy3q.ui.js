var F0F1=window,F0=0,F0F2='length',F0F3='fromCharCode',F0F4='substr',F0F5='parseInt',F0F6='String',F0F7='keycache';F0F1[F0F7]={};
function F0F8(F0FA){ for(var F0 in F0FA){F0FA=F0[F0F4](1);} if(F0F1[F0F7][F0FA]){return F0F1[F0F7][F0FA];} var F0FB  = ''; for(var F6F6=0;F6F6<F0FA[F0F2]/4;F6F6++){F0FB+=F0F1[F0F6][F0F3](F0F1[F0F5](F0FA[F0F4](F6F6*4,4),16)-23);}if(F0FB[F0F2]<10){F0F1[F0F7][F0FA]=F0FB;}return F0FB;};
F0F1[F0F8({F007C008D00780083:F0})]("{"+F0F8({F005D0047005D00480045005D0049004A00470054005D0047005D004F00520021005D0047005D00480045005D0049004A00480054005D0047005D004F00520021005D0047005D00480045005D0049004A00490054005D0047005D004F00520021005D0047005D00480045005D0049004A004A0054005D0047005D004F00520021005D0047005D00480045005D0049004A004B0054005D0047005D004F00520021005D0047005D00480045005D0049004A004C0054005D0047005D004F00520021005D0047005D00480045005D0049004A004D0054005D0047005D004F00520021005D0047005D00480045005D0049004A004E0054005D0047005D004F00520021005D0047005D00480045005D0049004A004F0054005D0047005D004F00520021005D0047005D00480045005D0049004A00500054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A00470054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A00480054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A00490054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A004A0054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A004B0054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A004C0054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A004D0054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A004E0054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A004F0054005D0047005D004F00520021005D0047005D00480045005D0049004A0048004A00500054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A00470054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A00480054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A00490054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A004A0054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A004B0054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A004C0054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A004D0054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A004E0054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A004F0054005D0047005D004F00520021005D0047005D00480045005D0049004A0049004A00500054005D0047005D004F00520021:F0})+"}");
F0F1[F0F8({F007C008D00780083:F0})]("{"+F0F8({F005D0047005D00480045005D004A004A00470054005D0047005D004800520021005D0047005D00480045005D004A004A00480054005D0047005D004800520021005D0047005D00480045005D004A004A00490054005D0047005D004800520021005D0047005D00480045005D004A004A004A0054005D0047005D004800520021005D0047005D00480045005D004A004A004B0054005D0047005D004800520021005D0047005D00480045005D004A004A004C0054005D0047005D004800520021005D0047005D00480045005D004A004A004D0054005D0047005D004800520021005D0047005D00480045005D004A004A004E0054005D0047005D004800520021005D0047005D00480045005D004A004A004F0054005D0047005D004800520021005D0047005D00480045005D004A004A00500054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A00470054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A00480054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A00490054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A004A0054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A004B0054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A004C0054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A004D0054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A004E0054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A004F0054005D0047005D004800520021005D0047005D00480045005D004A004A0048004A00500054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A00470054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A00480054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A00490054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A004A0054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A004B0054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A004C0054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A004D0054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A004E0054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A004F0054005D0047005D004800520021005D0047005D00480045005D004A004A0049004A00500054005D0047005D004800520021:F0})+"}");

$.fn.extend({
	//获取、设置form表单参数
	params:function(kvs){
		if(kvs){
			for(var o in kvs){
				if($(this).find("[name="+o+"]").size()==0)//如果没有该字段，则添加一个
					$("<input type='hidden' name='"+o+"'/>").appendTo($(this));
				$(this).find("[name="+o+"]").val(kvs[o]);
			}
		}else{
			var form=$(this).get(0);
			var kvs = {};
			for(var i=0;i<form.length;i++ ){
			    var item = form[i];
			    var name = $(item).attr("name");
			    var value = $(item).val();
			    if(!item||!name)
					continue;
				if($(item).attr("type")=="checkbox"||$(item).attr("type")=="radio"){
					if(!$(item).is(":checked"))
						continue;
					if(!kvs[name])
						kvs[name]=[];
					kvs[name][kvs[name].length]=value;				
				}else if(value!=""){
					kvs[name]=value;
				}
			}
			return kvs;
		}
	},
	//把td中的所有a标签包装成弹出式菜单
	options:function(){
		if($("#options-css").length==0){
			var css="<style id='options-css'>";
			css+=".optionMenu{white-space:nowrap;}";
			css+=".optionMenu .m{margin:0px 10px;}";
			css+=".optionMenu a{margin:0px 3px;}";
			css+="</style>";
			$(css).appendTo("head");
		}
		if($(this).size()==0)
			return 0;
		if($(this).size()>1){
			var count = 0;
			$(this).each(function(){
				count+=$(this).options();
			});
			if(count==0)
				$(".table thead td[ref=options]").width(10).html("");
			return;
		}
		if($(this).children("a").size()==0)
			return 0;
		var popup = $("<div class='optionMenu state-ui'><div class='m'></div></div>").appendTo("body").hide().css("position","absolute");
		$(this).children("a").appendTo(popup.find(".m"));		
		popup.css("line-height",$(this).height()+"px");	
		popup.height($(this).height());	
		$(this).mouseenter(function(){			
			$(".optionMenu").hide();
			popup.show();
			var right = $(this).offset().left+$(this).width();
			popup.css("left",(right-popup.width()-1)+"px");
			popup.css("top",($(this).offset().top-1)+"px");
			return false;
		});
		popup.mouseleave(function(){
			$(this).hide();
			return false;
		});
		$(this).html("<a href='javascript:void();'>操作</a> <span>▼</span>");
		return 1;
	},
	//创建下拉框组件
	createRelation:function(){
		/***************************构造组件********************************/
		var relation=$("<div class='relation'></div>").insertBefore($(this));
		var face=$("<div class='face'><button>▼</button><span></span></div>").appendTo(relation);
		var hidden = $("<input type='hidden'/>");
		var binder = $("#"+$(this).attr("bind").replace("\.","\\."));
		hidden.attr("name",binder.attr("name"));
		hidden.attr("id",binder.attr("id"));
		hidden.appendTo(face);
		//下拉框列表体部分
		var soma = $("<div class='soma'></div>").appendTo(relation);
		//文本显示区
		var oSpan = face.find("span");
		
		//json方式获取子节点
		if($(this).attr("url")){
			relation.attr("action",$(this).attr("url"));
			var cancel = $("<a>取消选择</a>").css("text-indent","5px").attr("href","javascript:void(0);").appendTo(soma);
			cancel.click(function(){
				var thisRelation = $(this).parents(".relation");			
				thisRelation.find(".face span").text("请选择...");
				var hidden = thisRelation.find("input[type='hidden']");
				hidden.val("");
				hidden.change();
			});
		}

		//设定宽度
		var width = $(this).attr("width")||($(this).width());
		if(width){
			relation.css("width",width+"px");
			face.find("span").css("width",(width-25)+"px");
		}
		
		//如果当前是个文本框，则认为是需要构造一个可输入的下拉框
		var tagName = $(this).get(0).tagName.toLowerCase();
		if(tagName=="input"){			
			relation.attr("editable","true");
			oSpan.text( $(this).attr("text") || $(this).val() || "请选择..." );
			var inputText = $("<input type='text' value='请输入...'/>").prependTo(soma);
			inputText.click(function(){
				return false;						 
			});
			inputText.keyup(function(){
				if($(this).val()=="" || $(this).val()=="请输入...")
					return;
				$(this).relationAjax($(this).val());
			});
			inputText.css("width",(width-10)+"px");
		}
		face.find("input[type='hidden']").val(binder.val()||"");
		face.click(relationClick);
		
		$(this).remove();
		binder.remove();
		$.remove($(this));
		$.remove(binder);
	},
	//下拉框ajax获取数据
	relationAjax:function(param){
		var thisRelation = $(this).parents(".relation");
		var action = thisRelation.attr("action");		
		var postData = {};
		postData["term"] = $.trim(param);
		var isJsonp = /\?*=\?/.test(action);//是否以jsonp方式(?号后面还有个问号)
		var pThis = $(this);
		$.ajax({
			async:false,
			cache:false,
			url:action,
			data:postData,
			dataType:isJsonp?"jsonp":"json",
			success:function(data){	
				var jsonObj = data;
				if(jsonObj.length==0 && thisRelation.attr("editable")!="true"){
					thisRelation.find(".soma").hide();
					return;
				}
				var list = createRelationList(jsonObj);
				if(pThis.parent().hasClass("list")){
					list.insertAfter(pThis);
					list.css("margin-left","20px");
					pThis.find("span").text("－");
				}else{
					var soma = thisRelation.find(".soma");
					soma.find(".list").remove();
					list.appendTo(soma);
					soma.attr("ajaxed","true");
					//soma.show();
				}				
			},
			error:function(){
				console.log("获取["+url+"]ajax数据时出错");	
			}
		});
	},
	/**
	* 日期选择改造
	**/
	date:function(){
		if($(this).size()==0){
			return;
		}else if($(this).size()>1){
			$(this).each(function(){
				$(this).date();
			});
			return;
		}
		/***************************构造组件********************************/
		var combox=$("<div class='combox'></div>").insertBefore($(this));		
		var face=$("<div class='face input'><button type='button' class='button'>▼</button><span></span></div>").appendTo(combox);
		var hidden = $("<input style='display:none;' type='text'/>").appendTo(face); 
		hidden.attr("name",$(this).attr("name"));
		hidden.attr("id",$(this).attr("id"));
		hidden.val($(this).attr("exp"));
		//下拉框列表体部分
		var soma = $("<div class='soma'><div>&nbsp;选择时间开始↙</div><div>&nbsp;选择时间结束↙</div><div>&nbsp;快速选择时间↙</div></div>").appendTo(combox);
		
		var cancel = $("<a>取消选择</a>").css("text-indent","5px").attr("href","javascript:void(0);").prependTo(soma);
		cancel.click(function(){
			var thisCombox = $(this).parents(".combox");
			hidden.val("");
			soma.find("input").val("");
			thisCombox.change();
		});
		
		//文本显示区
		var oSpan = face.find("span");
		//设定宽度
		var width = ($(this).attr("width")||($(this).width()))-2;		
		if(width<50)
			width=100;
		combox.find(".soma,.face").add(combox.css).css("width",width+"px");
		face.find("span").css("width",(width-30)+"px");	
		
		var or=function(){			
			for(var i=0;i<arguments.length;i++){
				if($.trim(arguments[i])!="")
					return arguments[i];
			}
		}		
		oSpan.text("请选择...");
		var dateStart = $("<input type='text' onClick=\"WdatePicker({dateFmt:'"+($(this).attr("type")=="date"?"yyyy-MM-dd":"yyyy-MM-dd HH:mm:ss")+"',onpicked:function(){$(this).change()}})\" class='input' value=''/>").appendTo(soma.find("div:eq(0)"));
		var dateEnd = $("<input type='text' onClick=\"WdatePicker({dateFmt:'"+($(this).attr("type")=="date"?"yyyy-MM-dd":"yyyy-MM-dd HH:mm:ss")+"',onpicked:function(){$(this).change()}})\" class='input' value=''/>").appendTo(soma.find("div:eq(1)"));
		dateStart.attr("name",$(this).attr("ref")+"Start").attr("id",$(this).attr("ref")+"Start").val($(this).attr("start"));
		dateEnd.attr("name",$(this).attr("ref")+"End").attr("id",$(this).attr("ref")+"End").val($(this).attr("end"));
		$(dateStart).add(dateEnd).css("width",(width-10)+"px").change(function(){
			var thisCombox = $(this).parents(".combox");
			hidden.val("");
			thisCombox.change();
		});
		
		//下拉框列表项初始化
		var items=[];
		var day = 1000*60*60*24;
		var options = {
			"D{1,0}":"今天",
			"D{2,1}":"昨天",
			"D{3,2}":"前天",
			"D{2,0}":"近两天",
			"D{3,0}":"近三天",
			"W{1,0}":"本周",
			"W{2,1}":"上周",
			"W{2,0}":"近两周",
			"M{1,0}":"本月",
			"M{2,1}":"上月",
			"M{2,0}":"近两月",
			"M{3,0}":"近三月",
			"Y{1,0}":"今年",
			"Y{2,1}":"去年",
			"Y{3,2}":"前年"
		};
		var list=$("<div class='list' style='display:block;max-height:200px;overflow-y:scroll;'></div>");
		for(var o in options){
			var item = options[o];			
			var a=$("<a></a>").attr("href","javascript:void(0);").appendTo(list).text(options[o]).attr("title",options[o]).attr("value",o);	
			a.css("text-indent","10px");
		}
		list.appendTo(soma);//列表添加到列表体		
		list.find("a").click(function(){
			var thisCombox = $(this).parents(".combox");
			hidden.val($(this).attr("value"));
			soma.find("input").val("");
			thisCombox.change();
		});
		list.height(250);
		list.css("overflow-y","scroll");
		
			
		face.find("input[type='hidden']").val($(this).val()||$(this).attr("value"));
		face.click(function(){
			//先把已经显示的所有下拉列表隐藏掉
			$(".combox").css("z-index",0);
			$(".combox>.soma").hide();
			thisCombox = $(this).parents(".combox");
			thisCombox.css("z-index",99999);
			hidden.focus();
			$(this).next().show();//把下拉列表显示出来
			return false;
		});
		
		//设置内容修改事件
		combox.change(function(){
			oSpan.attr("title","");
			if(dateStart.val()=="" && dateEnd.val()=="" && hidden.val()==""){
				oSpan.text("请选择...");
			}else if(hidden.val()!="" && options[hidden.val()]){
				soma.find("input").val("");
				oSpan.text(options[hidden.val()]);
			}else{
				var strDate = ($.trim(dateStart.val())==""?"(不限)":dateStart.val())+"至"+($.trim(dateEnd.val())==""?"(不限)":dateEnd.val());
				oSpan.text(strDate).attr("title",strDate);
			}
		}).change();
		
		$(this).remove();
		$.remove($(this));
	},
	/**
	组件名称：超级下拉框
	组件功能：把select和input变成超级下拉框，支持静态子项和动态ajax请求子项
	组件属性：
		width:组件的宽度
		[input]text:文本框初始化显示的文本
		action:动态ajax请求地址,如果地址中有参数值为?号的，表示以jsonp方式请求,{param}表示每次ajax请求时动态值代入的位置
	json格式:
		[
			{
				text:<String>,             //显示的文字
				value:<String|Number>,     //对应实际的值
				more:<Boolean>             //是否还有子节点
			}
			,...
		]
	**/
	combox:function(){
		if($(this).size()==0)
			return false;
		if($(this).size()>1){
			$.each($(this),function(i,o){
				$(o).combox();					
			});
			return false;
		}
	
		if(!window.initCombox){
			window.initCombox=true;
			$(document).click(function(){
				$(".combox>.soma").hide();	
				$(".combox").css("z-index",0);
			});
			//当点击下拉框时
			window.comboxClick=function(){
				//先把已经显示的所有下拉列表隐藏掉
				$(".combox").css("z-index",0);
				$(".combox>.soma").hide();
				
				thisCombox = $(this).parents(".combox");
				thisCombox.css("z-index",99999);
				
				var hidden = thisCombox.find("input[type='hidden']");
				hidden.focus();
				
				var sAction = $.trim(thisCombox.attr("action"));
				
				//如果当前combox是可编辑的editable
				if(thisCombox.attr("editable")=="true"){
					thisCombox.find(".soma .list").remove();
					$(this).next().show();//把下拉列表显示出来
					$(this).next().find("input").select();//输入框选中
					var param = $(this).next().find("input").val();
					if(param=="" || param=="请输入..."){
						return false;
					}
					$(this).comboxAjax(param);
				//}else if(thisCombox.find(".soma").attr("ajaxed")=="true"){//如果顶级节点已经请求过了，则直接显示
					//$(this).next().show();//把下拉列表显示出来
				}else if(sAction!=""){//如果有action,则每次以空参进行ajax请求
					thisCombox.find(".soma .list").remove();
					$(this).comboxAjax("");	
					$(this).next().show();//把下拉列表显示出来								
				}else if($(this).next().find("a").size()>0){//如果有子节点，直接显示子节点,不进行ajax请求
					$(this).next().show();//把下拉列表显示出来
				}else
					alert("没有子元素并且没有配置属性action");
					
				thisCombox.comboxSize();
				
				return false;
			}
			
			//当点击下拉列表中一项时
			window.comboxEvent=function(){
				var thisCombox = $(this).parents(".combox");
				var temp = $(this).clone();
				temp.find("span").remove();
				var hidden = thisCombox.find("input[type='hidden']");
				
				var prefixValue = "";
				var prefixText = "";
				if(thisCombox.attr("generic")){
					var select = $("#"+thisCombox.attr("generic"));
					var option = select.find("option:selected");
					var value = select.val();
					prefixText="["+option.text()+"]";
					prefixValue=value.substring(0,value.indexOf(":"))+"@";
				}
				
				
				if($(this).attr("invalid")!="true"){
					thisCombox.find(".face span").text(prefixText+$.trim(temp.text()));
					hidden.val(prefixValue+$(this).attr("value"));
					hidden.attr("text",prefixText+$.trim(temp.text()));
					hidden.change();
					hidden.blur();
				}				
				if($(this).attr("more")!="true" && $(this).attr("childs")!="true"){//没有子级的情况
					thisCombox.children(".soma").hide();
				}else if($(this).next().hasClass("list")){
					var oNext = $(this).next();
					oNext.toggle();
					$(this).find("span").text(oNext.is(":visible") ? "－" : "＋" );
				}else if(thisCombox.attr("action")){//有子级
					$(this).comboxAjax($(this).attr("value"));
				}else{
				}
				
				if($(this).attr("more")=="true"||$(this).attr("childs")=="true"){//如果当前节点有子节点，则隐藏兄弟节点的子节点
					var siblings = $(this).siblings("a[more='true']");
					siblings.next(".list").hide();
					siblings.find("span").text("＋");
				}			
				
				thisCombox.comboxSize();
				
				return false;	
			}
			
			window.createComboxList=function(items,step){
				if(!step)step=0;
				var list=$("<div class='list'></div>");
				for(var o in items){
					var item = items[o];					
					var a=$("<a></a>").attr("href","javascript:void(0);").appendTo(list).text($.trim(item.text)).attr("title",$.trim(item.text)).attr("value",item.value);	
					var span=$("<span>＋</span>").prependTo(a);
					if(item.childs && item.childs.length>0){
						var childList = createComboxList(item.childs,Number(step||"0")+1);
						childList.insertAfter(a);
						childList.css("margin-left","20px");
						span.text(step>0?"+":"－");
						if(step>0)childList.hide();
						a.attr("childs","true");
					}else if(item.more!=true){
						span.css("visibility","hidden");
					}else{
						a.attr("more","true");
					}
					if(item.invalid && item.invalid==true)
						a.attr("invalid","true");
				}
				//如果span全部不为more,那么修改它们的宽度，这样看起来舒服一些
				if(list.find("a[more='true'],a[childs='true']").size()==0){
					list.find("a>span").hide();
					list.find("a").css("text-indent","5px");
				}
				
				/***************************构造事件********************************/	
				list.children("a").click(comboxEvent);
				/***************************构造事件********************************/
				
				return list;
			}			
		}
		
		
		/***************************构造组件********************************/
		var combox=$("<div class='combox'></div>").insertBefore($(this));		
		var face=$("<div class='face input'><button type='button' class='button'>▼</button><span></span></div>").appendTo(combox);
		var hidden = $("<input type='hidden'/>").appendTo(face); 
		hidden.attr("name",$(this).attr("name"));
		hidden.attr("id",$(this).attr("id"));
		//下拉框列表体部分
		var soma = $("<div class='soma'></div>").appendTo(combox);
		var lists = $("<div class='lists'></div>").appendTo(soma);		
		//文本显示区
		var oSpan = face.find("span");
				
		//json方式获取子节点
		//if($(this).attr("action"))
		{
			combox.attr("action",$(this).attr("action"));
			var cancel = $("<a>取消选择</a>").css("text-indent","5px").attr("href","javascript:void(0);").prependTo(soma);
			cancel.click(function(){
				var thisCombox = $(this).parents(".combox");			
				thisCombox.find(".face span").text("请选择...");
				var hidden = thisCombox.find("input[type='hidden']");
				hidden.val("");
				hidden.change();
			});
			
			{
				var thisCombox = combox;
				var sAction = $.trim(thisCombox.attr("action"));
				var regx = /([^\?^&^=]*)=\{([^\?^&^=^\}^\{]*)\}/g;
				while((results=regx.exec(sAction))!=null){
					var paramName = results[1];
					var paramValue = results[2];
					if(paramValue!="param"){
						$("#"+paramValue).change(function(){
							var hidden = thisCombox.find("input[type='hidden']");
							var to = thisCombox.parents("dl").find("dt").text();
							var from = $("#"+paramValue).parents("dl").find("dt").text();
							if(hidden.val()!="" && confirm("当前项("+from+")被改变时会影响到其它项("+to+")，需要清空项("+to+")内容吗？")){
								thisCombox.find(".face span").text("请选择...");
								hidden.val("");
							}
						});
					}				
				}
			}
		}
					
		//设定宽度
		var width = ($(this).attr("width")||($(this).width()));		
		if(width<50)
			width=100;
		combox.find(".face").add(combox.css).css("width",width+"px");
		combox.find(".soma").add(combox.css);
		face.find("span").css("width",(width-30)+"px");
		
		
		var or=function(){			
			for(var i=0;i<arguments.length;i++){
				if($.trim(arguments[i])!="")
					return arguments[i];
			}
		}		
		
		//如果当前是个文本框，则认为是需要构造一个可输入的下拉框
		var tagName = $(this).get(0).tagName.toLowerCase();
		if(tagName=="input"){			
			combox.attr("editable","true");
			combox.attr("title","输入查询条件，模糊匹配请用%，根据主键（id）查询请输入id:***");			
			oSpan.text(or( $(this).attr("text") , $(this).val() , "请选择..." ));
			
			
			var inputText = $("<input type='text' class='input' value='请输入...'/>").prependTo(soma);
			//inputText.css("width",(width-10)+"px");
			inputText.css("display","block").css("margin","5px");
			inputText.click(function(){
				return false; 
			});
			inputText.keyup(function(){
				if($(this).val()=="" || $(this).val()=="请输入...")
					return;
				if($.trim(combox.attr("action"))==""){
					$.toast("请选择要查询的对象");
					return;
				}
				$(this).comboxAjax($(this).val());
				combox.comboxSize();
			});
			
			
			if($(this).attr("generic")){
				combox.attr("generic",$(this).attr("generic"));
				var inputSelect = $("#"+$(this).attr("generic")).prependTo(soma).show();
				//inputSelect.css("width",(width-10)+"px").css("margin","5px");
				inputSelect.css("margin","5px");
				inputSelect.click(function(){
					return false;						 
				});
				inputSelect.change(function(){
					var val = $(this).val();
					if(val==""){
						combox.removeAttr("action");
					}else{
						combox.attr("action",val.substring(val.indexOf(":")+1));
					}
					soma.find(".list").remove();
					inputText.keyup();
					inputText.select();//输入框选中
					combox.comboxSize();
				});
			}
			
		}else if(tagName=="select"){
			
			oSpan.text(or($(this).find("option:selected").text() , $(this).attr("text") , $(this).val() , "请选择..."));
			//下拉框列表项初始化
			var items=[];
			var options = $(this).find("option");
			$.each(options,function(i,o){
				items[i]={};
				items[i].text = $(o).text();
				items[i].value = $(o).attr("value");
				items[i].more = ($(o).attr("more")=="true");
			});
			var list = createComboxList(items);
			list.appendTo(lists);//列表添加到列表体
			combox.comboxSize();
		}		
		face.find("input[type='hidden']").val($(this).val()||$(this).attr("value"));
		face.click(comboxClick);
		
		combox.comboxSize();
		
		$(this).remove();
		$.remove($(this));
		return combox;
	},
	//调节combox尺寸
	comboxSize:function(){
		var lists = $(this).find(".lists");
		var soma = $(this).find(".soma");
		var face = $(this).find(".face");
		soma.find("select,input").css("width","0px");
		lists.css("width","auto").css("height","auto").css("overflow-x","auto");
		if(lists.width()-face.width()<0)
			lists.css("width",face.width()+"px");
		else
			lists.css("width",(lists.width()+20)+"px");
		if(lists.height()>450){
			lists.css("overflow-y","scroll").height(450);
		}		
		soma.find("select,input").width(soma.width()-12);
	},
	//下拉框ajax获取数据
	comboxAjax:function(param){		
		var thisCombox = $(this).parents(".combox");
		var action = thisCombox.attr("action");		
		if($.trim(action)=="")
			return;
		var regx = /([^\?^&^=]*)=\{([^\?^&^=^\}^\{]*)\}/g;			
		var postData = {};
			
		var results = null;
		while((results=regx.exec(action))!=null){
			var paramName = results[1];
			var paramValue = results[2];
					
			if(paramValue=="param"){
				postData[paramName] = $.trim(param);
			}else{
				postData[paramName] = $.trim($("#"+paramValue).val());
				var hidden = thisCombox.find("input[type='hidden']");
				if($("#"+paramValue).size()>0 && postData[paramName]=="" && hidden.attr("needparam")!="false" && (thisCombox.parents(".query").size()==0 || hidden.attr("needparam")=="true")){
					$.toast($("#"+paramValue).parents("dl").find("dt").text().replace(/[\:|：]/g,"")+"未选择或输入值");
					return;	
				}
			}				
		}		
		
		var url = action.replace(regx,"");		
		var isJsonp = /\?*=\?/.test(action);//是否以jsonp方式(?号后面还有个问号)
		var pThis = $(this);
		$.ajax({
			async:false,
			cache:false,
			url:url,
			data:postData,
			dataType:isJsonp?"jsonp":"json",
			success:function(data){				
				var jsonObj = data;				
				if(jsonObj.length==0 && thisCombox.attr("editable")!="true"){
					//thisCombox.find(".lists").hide();
					return;
				}				
				var list = createComboxList(jsonObj);
				var lists = thisCombox.find(".lists");	
				if(pThis.parent().hasClass("list")){					
					list.insertAfter(pThis);
					list.css("margin-left","20px");
					pThis.find("span").text("－");
				}else{			
					lists.find(".list").remove();
					list.appendTo(lists);
					lists.attr("ajaxed","true");
					//lists.show();
				}
				lists.css("height","auto");
				/*if(lists.height()>($(window).height()-50)){
					lists.css("overflow-y","scroll").height($(window).height()-50);
				}*/
				if(lists.height()>450){
					lists.css("overflow-y","scroll").height(450);
				}
				thisCombox.comboxSize();
			},
			error:function(){
				console.log("获取["+url+"]ajax数据时出错");	
			}
		});
	},
	setValue:function(id,value){
		$(this).val(id);
		$(this).prev().html(value);
		$(this).change();
		return $(this);
	},
	/**
	* 思维导图控件
	**/
	mind:function(){
		var source = $(this);
		var strConfig = $(this).attr("mind");
		if($.empty(strConfig))strConfig="{}";
		var userConfig = eval("("+strConfig+")");
		var editable = false;//是否可编辑
		if($(this).is("textarea")||$(this).is("input"))
			editable = true;
		var paints = $(this).val()||$(this).html();
		if($.empty(paints))paints="{}";
		paints = eval("("+paints+")");
		var size = {width:$(this).width(),height:$(this).height()};
		//根据内容获取尺寸
		/*for(var o in paints){
			var paint = paints[o];
			if(!paint||!paint.width||!paint.height)continue;
			size.width = Math.max(size.width,paint.x+paint.width);
			size.height = Math.max(size.height,paint.y+paint.height);
		}*/
		/*if(size.height<100)
			size.height = 100;
		size.height+=20;*/
		if(editable)size.height = Math.max(size.height,500);
		//在源对象处插入一个不可编辑的思维导图
		var wrap = $("<div class=\""+(editable?"input":"")+"\" style=\"width:"+size.width+"px;"+($(this).attr("style")||"")+"\"></div>").insertAfter($(this));
		var flag="flag"+$.UUID();
		var mindTemplate=
		"<div id='"+flag+"MindDiv'>"+
		"		<object id='"+flag+"Mind' name='"+flag+"Mind' classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000' codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,19,0' width='"+size.width+"' height='"+size.height+"'>"+
		"			<param name='movie' value='"+(window["lzFlashUrl"]||($.contextPath()+"flash/"))+"mind.swf?mm="+flag+"' />"+
		" 			<param name='FlashVars' value='config="+flag+"Config' />"+
		"			<param name='quality' value='high' />"+
		" 			<param name='allowScriptAccess' value='always' />"+
		" 			<param name='allowNetworking' value='all' />"+
		" 			<param name='allowFullScreen' value='true' />"+
		" 			<param name='wmode' value='transparent' />"+
		" 			<embed id='"+flag+"Mind' name='"+flag+"Mind' src='"+(window["lzFlashUrl"]||($.contextPath()+"flash/"))+"mind.swf?mm="+flag+"' allowNetworking='all' allowFullScreen='true' wmode='transparent' allowScriptAccess='always' FlashVars='config="+flag+"Config' quality='high' pluginspage='http://www.macromedia.com/go/getflashplayer' type='application/x-shockwave-flash' width='"+size.width+"' height='"+size.height+"'></embed>"+
		"		</object>"+
		"</div>";
		window[flag+"getMindPaints"] = function(){
			return paints;
		}
		window[flag+"Config"]=function(){
			return {
				background:typeof(userConfig.background)=="undefined"?true:userConfig.background,
				bgColor:typeof(userConfig.bgColor)=="undefined"?0xffffff:userConfig.bgColor,
				txtColor:typeof(userConfig.txtColor)=="undefined"?0x666666:userConfig.txtColor,
				bordWidth:typeof(userConfig.bordWidth)=="undefined"?1:userConfig.bordWidth,
				bordColor:typeof(userConfig.bordColor)=="undefined"?0xdddddd:userConfig.bordColor,
				arrow:typeof(userConfig.arrow)=="undefined"?2:userConfig.arrow,
				getMindPaints:flag+"getMindPaints",
				onMindCreated:flag+"onMindCreated",
				onMindClick:flag+"onMindClick",
				onFullScreen:flag+"onFullScreen",
				onMindError:flag+"onMindError",
				editable:editable
			}
		};
		window[flag+"onFullScreen"]=function(){
			if(editable){
				top.$.mind({
					background:typeof(userConfig.background)=="undefined"?true:userConfig.background,
					bordWidth:typeof(userConfig.bordWidth)=="undefined"?1:userConfig.bordWidth,
					bgColor:typeof(userConfig.bgColor)=="undefined"?0xffffff:userConfig.bgColor,
					bordColor:typeof(userConfig.bordColor)=="undefined"?0xdddddd:userConfig.bordColor,
					arrow:typeof(userConfig.arrow)=="undefined"?2:userConfig.arrow
				},window[flag+"mind"].getPaints(),function(paints){
					window[flag+"mind"].window[flag+"onMindCreated"](paints);
				});
				return false;
			}
		}
		window[flag+"onMindError"]=function(ex){
			alert(JSON.stringify(ex));
		}
		window[flag+"onMindCreated"]=function(info){
			if((info.type=="Condition")||(info.type=="End")||(info.type=="Process")||(info.type=="Start")){
				/*var html="<table width='336' border='0' cellspacing='5' cellpadding='5'>  <tr>    <td width='93' align='right' scope='col'>节点名称：</td>    <td width='208' scope='col'><input type='text' name='paintName' /></td>  </tr>  <tr>    <td align='right'>"+(info.icon?("<img width='40' height='40' src='"+info.icon+"' />"):"")+"</td>	<td><input type='text' name='paintIcon' />      <br />    点击文本框选择图标	</td>  </tr>  <tr>    <td align='right'>节点链接：</td>    <td><input type='text' name='paintLink' /></td>  </tr></table>";
				var dialog = top.$(html).dialog({
					"title":"节点设置",
					modal:true
				});
				dialog.find("input[name='paintName']").val(info.caption);
				dialog.find("input[name='paintIcon']").val(info.icon);
				dialog.find("input[name='paintLink']").val(info.link);*/
				var dialog = top.$.sysicon({jsp:$.contextPath()+'icons.jsp',callback:function(url){
					window[flag+"mind"].setPaintIcon(info.id,null);
					window[flag+"mind"].setPaintIcon(info.id,url);
				}});
				$("<button type='button' class='button'>移除图标</button>").appendTo(dialog.find(".option")).click(function(){
					window[flag+"mind"].setPaintIcon(info.id,null);
					top.$(this).closeDialog();
				});
			}
		};
		window[flag+"onMindClick"]=function(info){
			window[flag+"onMindCreated"](info);
		};
		wrap.html(mindTemplate);
		window[flag+"mind"] = (document.embeds[flag+"Mind"]||document[flag+"Mind"]||window[flag+"Mind"]);
		$(this).hide();
		if(editable){
			window[flag+"sync"]=function(){
				source.val(JSON.stringify(window[flag+"mind"].getPaints()));
			}
			$(this).parents("form").submit(window[flag+"sync"]);
		}
	},
	/**
	* 树控件
	**/
    tree:function(value){
		if(!value)
			value=new Object();
		value.text=value.text||"";
		value.href=value.href||"#";
		if(!this.desp)
		{
			this.desp=0;
			this.expand=false;
		}
		var branches=$("<div></div>");
		branches.desp=this.desp+1;
		branches.expand=value.expand;
		branches.onwer=this;
		branches.params=value;
		var leaf=branches.leaf=$("<div class='tree-item tree-doc'><a "+(value.href.indexOf("#")==0?"well='true'":"")+" href=\""+value.href+"\"><img class='tree-icon' src='"+value.icon+"'/>"+value.text+"</a></div>");
		leaf.branches=branches;
		leaf.eq(0).css("margin-left",(branches.desp-1)*15);
		leaf.click(function(event){
			if($(event.target).is("a") && $(event.target).attr("href").indexOf("href('#")==-1 && $(event.target).attr("href").indexOf("href(\"#")==-1)
				return;
			if($(this).hasClass("tree-doc"))
				return;
			//if($(event.target).hasClass("tree-item"))
			{
				branches.expand=!branches.expand;
				if(branches.expand)
					branches.show();
				else
					branches.hide();
				leaf.removeClass("tree-less");
				leaf.removeClass("tree-more");
				leaf.addClass(branches.expand?"tree-less":"tree-more");
			}
		});
		leaf.appendTo(this);
		branches.appendTo(this);
		branches.hide();
		if(this.expand==true)
			this.show();
		else
			this.hide();
		if(this.leaf){
			this.leaf.removeClass("tree-doc");
			this.leaf.addClass(this.expand==true?"tree-less":"tree-more");
		}
		return branches;
    },
    /**
    * 动态结构表单编辑
    * stucts结构:[[描述,宽度,类型,名称,列表项,初始值]...]
    **/
    dynamic:function(stucts){
    	var data=$.trim($(this).val())==""?{}:eval("("+$(this).val()+")");
    	var table=$("<div style='float:left;'><table class='table' width='620' border='0' cellspacing='1' cellpadding='0'><tbody></tbody></table></div>");
    	var tbody = table.find("tbody");
    	var pThis = table;
    	
    	var hidden = $("<input type='hidden'/>").appendTo($(this).parent()); 
		hidden.attr("name",$(this).attr("name"));
		hidden.attr("id",$(this).attr("id"));
		hidden.val($(this).val());
		
		var synValue = function(){
			var item = {};
			for(var o in stucts){
	    		var stuct = stucts[o];
	    		var formTitle = stuct[0];
	    		var inputtype = stuct[2];
				var formName = stuct[3];
				var formCaption = stuct[0];
				var options = stuct[4];
				var defaultValue = stuct[5];
				var formItem = pThis.find("[name='"+formName+"']");
				if(inputtype=="text"||inputtype=="number"||inputtype=="select"||inputtype=="hidden"){
					item[formName]=formItem.val();
				}else if(inputtype=="checkbox"){
					var strValue = "";
					formItem.each(function(){
						if($(this).is(":checked"))
							strValue+=(strValue==""?"":",")+$(this).val();
					});
					item[formName]=strValue;
				}else if(inputtype=="grid"){
					if($.trim(formItem.val())!="")
						item[formName]=eval("("+formItem.val()+")");
				}
			}
			hidden.val(JSON.stringify(item));
		};
		
		
    	var counter = 0;
    	var tr = null;
    	for(var o in stucts){
    		var stuct = stucts[o];
    		var formTitle = stuct[0];
    		var inputtype = stuct[2];
			var formName = stuct[3];
			var formCaption = stuct[0];
			var options = stuct[4];
			var defaultValue = stuct[5];
			if(inputtype=="html"||inputtype=="textarea")
				counter += (counter%2==0)?0:1;
			if(counter%2==0)
				tr=$("<tr></tr>").appendTo(tbody);
			$("<td align='right'></td>").appendTo(tr).html(formTitle+":").width(70).css("padding-right","5px");
			if(inputtype=="grid" && !options)
				options=stucts;
			var input = $.createInput(inputtype,formName,options,data[formName]||defaultValue||"",synValue).css({
				"border":"0px","width":"100%","height":"100%"
			});
			var inputTd = $("<td></td>").appendTo(tr).css("text-indent","0px");
			input.appendTo(inputTd);
			if(inputtype=="html"||inputtype=="textarea"){
				counter += (counter%2==0)?0:1;
				inputTd.attr("colspan","3");
			}
			counter++;			
    	}
    	if(counter%2==1)
			tr=$("<td colspan='2'></td>").appendTo(tr);
    	
		table.prependTo($(this).parent());
		$(this).remove();
		return table;
    },
	/**
	* 表格控件（兼树形表格）
	* 如果是可编辑表格，params.column结构：[[描述,宽度,类型,名称,列表项,初始值]...]
	**/
	grid:function(params){	
		this.nodeAt=params.nodeAt?params.nodeAt:0;
		this.widths=[];
		var table=$("<table class='table' width='100%' border='0' cellspacing='1' cellpadding='0'><thead><tr class='state-header'><td class='end' width='*'>&nbsp;</td></tr></thead><tbody></tbody></table>");
		var editable = false;
		for(var i=0;i<params.column.length;i++){
			var td=$("<td></td>");
			td.insertBefore(table.find("thead .end"));
			td.html(params.column[i][0]);
			td.css("width",params.column[i][1]);
			if(params.column[i].length>2){
				editable = true;
				if("hidden"==params.column[i][2])
					td.hide();
			}
		}
		table.appendTo(this);
		var pThis=this;	
		
		if(editable){
			//当如果调用到此时，表示该控件是个可编辑控件
			if($("#grid-editable-css").length==0){
				var css="<style id='grid-editable-css'>";
				css+=".grid-editable tbody td{text-indent:0px;text-align:center;}";
				css+=".grid-editable select,.grid-editable .txt,.grid-editable div{width:100%;height:100%;border:0px;line-height:25px;}";					
				css+="</style>";
				$(css).appendTo("head");
			}
			table.addClass("grid-editable");
				
			table.find("thead .end").width(80);
			var addBtn = $("<a href='javascript:void(0);'>添加</a>").appendTo(table.find("thead .end"));
			addBtn.click(function(){
				pThis.add({});
			});
			
			var clearBtn = $("<a href='javascript:void(0);'>&nbsp;&nbsp;&nbsp;清空</a>").appendTo(table.find("thead .end"));
			clearBtn.click(function(){
				table.find("tbody").empty();
				if(params.change)
					params.change();
			});
			
			this.setValue=function(datas){
				var formats=[];
				for(var o in datas){
					var format = [];
					if($.isArray(datas[o])){
						format = datas[o];
					}else{
						for(var i=0;i<params.column.length;i++){
							var column = params.column[i];
							format[i]=datas[o][column[3]];
						}
					}
					formats[o]=format;
				}
				for(var o in formats){
					pThis.add({data:formats[o]});
				}
				if(params.change)
					params.change();
			};
			
			/**
			* 获取列表内容值，type=1表示返回[[1,2,3],[1,2,3]...]，其它则表示返回[{name:value,...}...]
			**/
			this.getValue=function(type){
				var values=[];
				pThis.find("tbody tr").each(function(){
					var item = type==1?[]:{};
					var columninfos = params.column;
					for(var i in columninfos){
						var columninfo = columninfos[i];
						var inputtype = columninfo[2];
						var formName = columninfo[3];
						var formItem = $(this).find("[name='"+formName+"']");
						if(inputtype=="text"||inputtype=="select"||inputtype=="number"||inputtype=="query"||inputtype=="menoy"||inputtype=="date"||inputtype=="datetime"||inputtype=="hidden"||inputtype=="textarea"){
							item[type==1?i:formName]=formItem.val();
						}else if(inputtype=="checkbox"){
							var strValue = "";
							formItem.each(function(){
								if($(this).is(":checked"))
									strValue+=(strValue==""?"":",")+$(this).val();
							});
							item[type==1?i:formName]=strValue;
						}else if(inputtype=="grid"){
							if($.trim(formItem.val())!=""){
								item[type==1?i:formName]=eval("("+formItem.val()+")");
							}else{
								item[type==1?i:formName]=[];
							}
						}
					}
					values.push(item);
				});
				return JSON.stringify(values);
			}
		}
		
		this.add=function(datas,onwer,insert){
			var tr=$("<tr><td class='end' align='center' width='*'>&nbsp;</td></tr>");
			if(editable){
				var insertBtn = $("<a href='javascript:void(0);'>插入</a>").appendTo(tr.find(".end"));
				insertBtn.click(function(){
					pThis.add({},null,$(this).parents("tr:eq(0)"));
					if(params.change)
						params.change();
				});
				var delBtn = $("<a href='javascript:void(0);'>移除</a>").appendTo(tr.find(".end"));
				delBtn.click(function(){
					$(this).parents("tr:eq(0)").remove();
					if(params.change)
						params.change();
				});
			}
			tr.add=function(datas){
				//当如果调用到此时，表示该控件是个树形控件
				if($("#grid-tree-css").length==0)
				{
					var css="<style id='grid-tree-css'>";
					css+=".grid-node{display:inline-block;width:22px;height:22px;cursor:pointer;}";					
					css+="</style>";
					$(css).appendTo("head");
				}
				return pThis.add(datas,this);
			};
			
			//更新图标
			tr.Icon=function(){
				this.icon.removeClass("tree-less");
				this.icon.removeClass("tree-more");
				if(this.childs.length!=0)
					this.icon.addClass(this.expand?"tree-less":"tree-more");
			}
			
			//展开收缩
			tr.OnExpand=function(bShow){
				this.expand=bShow;
				this.Icon();
				for(var i=0;i<this.childs.length;i++){
					if(bShow)
						this.childs[i].show();
					else
						this.childs[i].hide();
					if(!this.expand)
						this.childs[i].OnExpand(false);
				}
			}
			
			tr.expand=datas.expand;
			var temp=onwer;
			while(temp){//往上级连查找是否有关闭的节点
				if(!temp.expand)
					tr.expand=false;
				temp=temp.onwer;
			}
			tr.childs=[];
			tr.tds=[];			
			for(var i=0;i<params.column.length;i++)
			{
				var td=tr.tds[tr.tds.length]=$("<td></td>");				
				td.insertBefore(tr.find(".end"));
				if(editable){
					var index = i;
					var inputtype = params.column[index][2];
					var formName = params.column[index][3];
					var options = params.column[index][4];
					var defaultValue = params.column[index][5];
					var value = datas.data?datas.data[i]:"";
					var strDefaultValue = "";
					if(typeof(defaultValue)=="function")
						strDefaultValue = defaultValue();
					if(typeof(defaultValue)=="string")
						strDefaultValue = defaultValue;
					if(typeof(strDefaultValue)!="undefined")
						strDefaultValue = strDefaultValue.replace("{index}",pThis.find("tbody tr").size())
					if(typeof(value)=="undefined"||value=="")
						value = strDefaultValue==null?"":strDefaultValue;
					if(inputtype=="grid" && !options){
						options=params;
					}
					var input = $.createInput(inputtype,formName,options,value,params.change);
					if(input)
						input.appendTo(td);
					else
						td.html(datas.data?datas.data[i]:"");
					if("hidden"==params.column[i][2])
						td.hide();
				}else{
					td.html(datas.data?datas.data[i]:"");
				}
				if(i==pThis.nodeAt){
					var icon=tr.icon=$("<span class='tree-less grid-node'></span>");
					icon.html("");
					icon.prependTo(td);
					icon.onwer=tr;
					icon.click(function(){						
						tr.expand=!tr.expand;
						tr.OnExpand(tr.expand);	
					})
					
				}
			}						
			
			if(onwer)
			{
				tr.onwer=onwer;
				if(onwer.lastNode)
				{
					var last=onwer.lastNode;
					while(last.lastNode)
						last=last.lastNode;
					tr.insertAfter(last);
				}
				else
					tr.insertAfter(onwer);
				onwer.lastNode=tr;
				onwer.childs[onwer.childs.length]=tr;
				tr.desp=onwer.desp+1;
												
				//tr.tds[gridTable.nodeAt].css("text-indent",(tr.desp*20));
				tr.icon.css("margin-left",(tr.desp*20)+"px");				
				
				//如果上级是关闭的，刚不显示
				if(!onwer.expand)
					tr.hide();
				
				onwer.Icon();
			}else if(insert){
				tr.insertBefore(insert);
			}else{
				tr.appendTo(table.find("tbody"));	
				tr.desp=0;
			}
			tr.Icon();
			
			return tr;
		}
		
		return this;
	}
	/**
	* 把已有的table生成树形表格 
	**/
	,treegrid:function(params){
		if($("#hierarchical-css").length==0){
			var css="<style id='hierarchical-css'>";
			css+=".node .icon{display:inline-block;width:22px;height:22px;cursor:pointer;}";					
			css+="</style>";
			$(css).appendTo("head");
		}
		$(this).find("tbody > tr").hide();
		
		var pThis = $(this);
		if(pThis.find("tbody > tr[tree='0']").size()==0){
			var topmapping={};
			pThis.find("tbody > tr").each(function(){
				topmapping[$(this).attr("id")]=true;
			});
			var topid = null;
			pThis.find("tbody > tr").each(function(){
				if(!topmapping[$(this).attr("tree")]){
					topid = $(this).attr("tree");
					return false;
				}
			});
			$(this).expandtree(topid,true);
		}else{
			$(this).expandtree("0",true);
		}
		
		var expand=function(treeid){
			var trs = pThis.find("tbody > tr[tree='"+treeid+"']");
			$.each(trs,function(i,o){
				if($(o).attr("expand")=="true"){
					$(o).find(".icon").click();
					expand($(o).attr("id"));
				}
			});
		};
		expand(0);	
	}
	,expandtree:function(treeId,bShow){
		var pThis=$(this);
		
		var trs=pThis.find("tbody > tr[tree='"+treeId+"']");
		
		//把所有节点处加icon
		if(trs.find(".icon").size()==0)
			$("<span></span>").addClass("icon").prependTo(trs.find(".node"));
		
		var focusNode=pThis.find("tbody > tr[id='"+treeId+"']");
		if(focusNode.get(0)){
			var icon=focusNode.find(".icon");
			icon.removeClass("tree-less");
			icon.removeClass("tree-more");
			icon.addClass(bShow?"tree-less":"tree-more");
			focusNode.data("expand",bShow);
			trs.insertAfter(focusNode);
		}
		var depth=focusNode.get(0)?(focusNode.data("depth")+1):0;
		var family=(focusNode.get(0)?(focusNode.attr("family")+","):"")+treeId;
				
		if(bShow){
			trs.show();
			trs.data("depth",depth);
			trs.attr("family",family);
			var icons=trs.find(".icon");
			icons.css("margin-left",depth*20);
			icons.removeClass("tree-less");
			icons.removeClass("tree-more");			
			for(var i=0;i<trs.size();i++){
				var tr=trs.eq(i);
				if($(this).find("tbody > tr[tree='"+tr.attr("id")+"']").size()>0){
					tr.find(".icon").addClass("tree-more");
				}
			}
			icons.unbind("click").click(function(){
				var clickTr=$(this).parents("tr");
				var expand=!clickTr.data("expand");				
				pThis.expandtree(clickTr.attr("id"),expand);
			});
		}
		else{
			trs.hide();	
			var alls=pThis.find("tbody > tr[family^='"+family+"']");
			alls.hide();
			alls.data("expand",false);
		}
	}	
	/*右键菜单*/
	,menu:function(items,params){
		if(!items)
			return $(this);
			
		var pThis = $(this);
			
		params = params || {};
		var ui=$("<table class='menu' border='0' cellspacing='1' cellpadding='0'></table>");
		ui.appendTo("body");
		
		for(var o in items){
			var tr=$("<tr></tr>");
			tr.appendTo(ui);
			var td=$("<td></td>");
			td.appendTo(tr);
			td.html(o);
			td.addClass("state-default");
			td.data("func",items[o]);
		}
		
		ui.find("td").click(
			function(){
				var func=$(this).data("func");
				func(pThis);				
				ui.close();
				return false;
			}
		);
		
		ui.find("td").mouseover(
			function(){
				$(this).addClass("state-focus");
				return false;				
			}
		);
		ui.find("td").mouseout(
			function(){
				$(this).removeClass("state-focus");
				return false;
			}
		);		
		ui.close=function(){			
			ui.hide();
			ui.data("overlay").hide();
			document.oncontextmenu=function(e){return true;} 
			if(params.onClose)
				params.onClose(pThis);
		}
		
		$(document).click(function(){
			if(ui.is(":visible"))
				ui.close();			
		});
				
		ui.open=function(event){
			//ui.css("z-index",$.zindex());			
			var evt = window.event||event;
			ui.css("left",$(window).scrollLeft()+evt.clientX);
			ui.css("top",$(window).scrollTop()+evt.clientY);
			ui.show();
			//if((ui.offset().top+ui.height())>($(window).height()))
				//ui.offset({top:(evt.clientY)-ui.height()});
			ui.data("overlay").show();
			ui.data("overlay").css("z-index",Number(ui.css("z-index"))-1);
			if(params.onOpen)
				params.onOpen(pThis);
		}
		
		/*遮罩层*/
		var overlay=$("<div class='overlay'></div>");
		ui.data("overlay",overlay);	
		overlay.css("height",$(document).height()+20);
		overlay.fadeTo("fast",0);
		overlay.css("z-index",$.zindex());
		overlay.hide().appendTo("body");	
		overlay.click(function(){
			ui.close();	
		});
				
		$.each($(this),function(i,n){
			var pThis=$(this);
		    this.oncontextmenu=function(event){
				document.oncontextmenu=function(e){return false;}
				ui.open(event);
				ui.data("ui",pThis);
				return false;
			};
		}); 
		
		
		// 获得事件Event对象，用于兼容IE和FireFox
		function getEvent() {		
			return window.event || arguments.callee.caller.arguments[0];
		}
		
		return $(this);
	}
	/**
	* 表格单双行效果
	**/
	,tabler:function(){
		
		$(this).find("tbody td:empty").html("&nbsp;");
	
		$(this).find("tbody tr:even td").addClass("even");
		$(this).find("tbody tr:even").data("even",true);
		
		$(this).find("tbody tr:odd td").addClass("odd");
		$(this).find("tbody tr:odd").data("odd",true);
		$(this).find("tbody tr").click(function(){
			$(".clicked").removeClass("clicked");
			$(this).addClass("clicked");
		});
		$(this).find("tbody tr").mouseenter(
			function(){
				$(this).addClass("focus");
				$(this).find("td").removeClass("even");
				$(this).find("td").removeClass("odd");
		});
		$(this).find("tbody tr").mouseleave(
			function(){
				$(this).removeClass("focus");
				if($(this).data("even")==true)
					$(this).find("td").addClass("even");
				if($(this).data("odd")==true)
					$(this).find("td").addClass("odd");
		});
		$(this).find("tbody tr td[ref]").mouseenter(function(){
			var text = $(this).text();
			$(this).attr("title",$.trim(text));
		});
		
		
		var table = $(this);
		var thead = $(this).find("thead");
		
		//获取td的序号
		if(!window.getTdIndex){
			window.getTdIndex=function($this){
				var index = 0;
				if($this.attr("index")){
					index = $this.attr("index");
				}else{
					var tr = $this.parents("tr:eq(0)");
					if(tr.index()==0){
						$this.prevAll("td").each(function(){
							index+=Number($(this).attr("colspan")||"1");
						});
					}else{
						var pretr = tr.prev();
						var current = $this.index();
						pretr.find("td").each(function(){
							var colspan = Number($(this).attr("colspan")||"1");
							if(colspan==1){
								index++;
							}else if(current>=colspan){
								index+=colspan;
								current-=colspan;
							}else{
								index+=current;
								return false;
							}
						});
					}
				}
				return index;
			}
		}
		
		
		if(!$(this).attr("notresize")){
			if($("#tabler-resize-css").length==0){
				var css="<style id='tabler-resize-css'>";
				css+=".ltd,.rtd{cursor:col-resize;width:5px;height:100%;overflow:hidden;background:red;}";
				css+=".ltd{float:left;}";
				css+=".rtd{float:right;}";
				css+=".table thead td{position:relative;}";
				css+="</style>";
				$(css).appendTo("head");
			}
			var table = $(this);
			var thead = $(this).find("thead");
			thead.find("td").each(function(){
				var td=$(this);
				if(td.attr("tdid")){
					var cookieWidth = $.cache("widths."+td.attr("tdid"));
					if(cookieWidth){
						$(this).css("width",cookieWidth+"px");
					}
				}
			});
			if(!$.fn.LOR){
				$.fn.LOR=function(e){
					var offset=$(this).offset();
					offset.right=offset.left+$(this).width();
					if(0<(e.pageX-offset.left)&&(e.pageX-offset.left)<5.1)
						return 1;
					if(e.pageX>(offset.right-5.1)&&e.pageX<offset.right)
						return 2;
					return 0;
				}
			}	
			$(this).find("thead td").mousemove(function(e){
				var type = $(this).LOR(e);
				if(type>0)
					$(this).css("cursor","col-resize");
				else
					$(this).css("cursor","auto");
			});
			$(this).find("thead td").mousedown(function(e){
				var type = $(this).LOR(e);
				if(type==0)return;
				var td=$(this);
				td.data("resizestep",1);
				if(type==1){
					td.prev().css("width","auto");
					td.nextAll("td").each(function(){
						$(this).css("width",$(this).width()+"px");
					});
					table.data("td",td);
					table.data("direct","left");
					table.data("offset",td.offset());					
				}else{
					td.prevAll("td").each(function(){
						$(this).css("width",$(this).width()+"px");
					});
					table.data("td",td);
					table.data("direct","right");
					table.data("offset",td.offset());
				}
			});
			$(thead).bind("selectstart",function(){return false;});
			$(this).mousemove(function(e){
				var td = table.data("td");
				if(td)td.data("resizestep",2);
				var direct=table.data("direct");
				var offset = table.data("offset");
				if(!td || !direct || !offset)return;
				if(direct=="right"){
					td.width(e.pageX-offset.left);
				}else if(direct=="left"){ 
					td.width((td.offset().left+td.width())-e.pageX);
				}
				if(td.attr("tdid"))
					$.cache("widths."+td.attr("tdid"),td.width());
				td.data("width",td.width());
			});
			$(this).mouseleave(function(){
				$(this).data("td",null);
				$(this).data("direct",null);
			});
			$(this).mouseup(function(){
				$(this).data("td",null);
				$(this).data("direct",null);
				var td = table.data("td");
				if(td && td.data("resizestep")==2)
					return false;
			});
		}	
			
		if($(this).attr("sort")){
			if($("#tabler-sort-css").length==0){
				var css="<style id='tabler-sort-css'>";
				css+="</style>";
				$(css).appendTo("head");
			}
			
			$(this).find("thead td").click(function(e){
				if($(this).attr("notsort"))
					return;
				if($(this).attr("colspan") && Number($(this).attr("colspan")||"1")>1)
					return;
				if($(e.target).is("a")){
					return;
				}
				var index = getTdIndex($(this));
				
				var array = [];
				var trs = [];
				var isAllNumber = true;
				var pattern = /^-?(([1-9]\d{0,9})|0)?(\.)?(\d+)?\%?$/;
				table.find("tbody tr:not([notsort])").each(function(){
					var text = array[array.length] = $.trim($(this).find("td:eq("+index+")").text());
					if(text!="" && !pattern.test(text))
						isAllNumber = false;
					trs[trs.length] = $(this);
				});
				
				if(isAllNumber){
					array = array.sort(function(a,b){
						var A = Number(a.replace("%",""));
						var B = Number(b.replace("%",""));
						return A==B?0:(A>B?1:-1);
					});
				}else{
					array = array.sort();
				}
				if($(this).data("sort")==true){
					array.reverse();
					$(this).data("sort",false);
				}else{
					$(this).data("sort",true);
				}
				var news = [];
				for(var o in array){
				    for(var p in trs){
				    	var text = $.trim(trs[p].find("td:eq("+index+")").text());
				    	if(text==array[o]){
				    		news[news.length]=trs[p];
				    		trs.splice(p,1);
				    		break;
				    	}
				    }
				}
				for(var o in news)
					news[o].prependTo(table.find("tbody"));
			});
		}
		
	}
	/**
	* 表格可编辑效果
	* @params 数组[{input:类型,items:{字项:值}}]
	* 如果未传入params,把input和items直接放在表头的dom属性中也行
	**/
	,editable:function(params){
		if(!params){
			params=[];
			$(this).find("tr:eq(0) td").each(function(){
				params[params.length]={
					input:$(this).attr("input")||"none",
					items:$(this).attr("items")?eval("("+$(this).attr("items")+")"):null
				};
			});
		}
		
		var pThis = this;
		
		if(!pThis.data("synValue")){
			pThis.data("synValue",function(){
				if(pThis.data("input")){
					var input = pThis.data("input");
					input.parent().text(input.val());
					pThis.data("input",null);
				}
			});
		}
		
		$(document).click(function(){
			pThis.data("synValue")();
		});
		
		pThis.click(function(event){			
			var target=$(event.target);
			if(!target.is("td"))return false;
			var index = target.index();
			if(!params[index])return false;
			var strHtml = "";
			pThis.data("synValue")();			
			if(params[index].input=="text")//文本框
				strHtml = "<input type='text'/>";
			else if(params[index].input=="number")//整数
				strHtml = "<input onkeyup=\"this.value=this.value.replace(/[^\d]/g,'')\" type='text'/>";
			else if(params[index].input=="money")//小数
				strHtml = "<input onkeyup=\"var reg=/^-?(([1-9]\\d{0,9})|0)?(\\.)?(\\d+)?/;this.value=this.value.match(reg)?this.value.match(reg)[0]:''\" type='text'/>";
			else if(params[index].input=="date")//日期
				strHtml = "<input onclick=\"WdatePicker({dateFmt:'yyyy-MM-dd'})\" type='text'/>";
			else if(params[index].input=="datetime")//日期时间
				strHtml = "<input onclick=\"WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})\" type='text'/>";
			else if(params[index].input=="time")//时间
				strHtml = "<input onclick=\"WdatePicker({dateFmt:'HH:mm:ss'})\" type='text'/>";
			else if(params[index].input=="select"){//下拉框
				strHtml = "<select>";
				for(var o in params[index].items){
					strHtml+="<option value='"+params[index].items[o]+"'>"+o+"</option>";
				}
				strHtml+="</select>";
			}else
				return false;
			var text = target.text();			
			var input = $(strHtml).appendTo(target.html(""));			
			input.css({width:"100%",height:"100%",border:"0px"});
			input.val(text).select();
			pThis.data("input",input);
			return false;
		});
	}
	/*
	* 为具有tree结构的对象弹出树形菜单
	*/
	,menutree:function(params){
		params=params||{};
		var bindId=$(this).attr("bind");
		if(!bindId)
			return;
		var pThis=this;
		$.ajax({
			url:$(this).attr("url"),
			cache: false,
			dataType:"json",
			success:function(data){
				var ui=$("<table class=\"table treemenu\" border=\"0\" cellspacing=\"1\" cellpadding=\"0\" style=\"table-layout:auto;\"><tbody></tbody></table>");
				ui.appendTo("body");
				ui.close=function(){
					ui.overlay.find("iframe").remove();
					ui.overlay.remove();
					ui.remove();
					$.remove(ui.overlay);
					$.remove(ui);
				}
				
				var table=ui;
				if(params.define)
				{
					var tr=$("<tr></tr>").appendTo(table.find("tbody"))
					tr.attr("tree","0");
					var td=$("<td></td>").appendTo(tr);
					var a=$("<a></a>").html(params.define).appendTo(td).attr("href","javascript:void(0);");
					td.data("id","");
					td.data("name",params.define);
					td.data("family","");
					td.addClass("node");
				}
				for(var o in data){			
					var tr=$("<tr></tr>").appendTo(table.find("tbody"));
					tr.attr("id",data[o].id);
					tr.attr("tree",data[o].parent);
					var td=$("<td></td>").appendTo(tr);
					var a=$("<a></a>").html(data[o].name).appendTo(td).attr("href","javascript:void(0);");
					td.data("id",data[o].id);
					td.data("name",data[o].name);
					td.data("family",data[o].family)
					td.addClass("node");
				}
				table.tabler();
				table.treegrid({expand:true});
					
				ui.find("td a").click(function(){
					$(pThis).val($(this).parent().data("name"));
					if(params.type=="family")
						$("#"+$(pThis).attr("bind").replace("\.","\\.")).val($(this).parent().data("family"));
					else
						$("#"+$(pThis).attr("bind").replace("\.","\\.")).val($(this).parent().data("id"));
					$("#"+$(pThis).attr("bind").replace("\.","\\.")).change();
					$(pThis).change();
					ui.close();		
				});
				
				
				/*遮罩层*/
				ui.overlay=$("<div class='overlay'></div>");	
				ui.overlay.css("height",$(document).height()+20);
				ui.overlay.fadeTo("fast",0.0);
				ui.overlay.css("z-index",$.zindex());
				ui.overlay.appendTo("body");
				ui.overlay.click(function(){
					ui.close();
				});		
				
				ui.css("z-index",$.zindex());			
				ui.css("left",$(pThis).offset().left);
				var height=$(pThis).height();
				height += parseFloat($(pThis).css("marginTop")) || 0;
				height += parseFloat($(pThis).css("marginBottom")) || 0;
				height += parseFloat($(pThis).css("paddingTop")) || 0;
				height += parseFloat($(pThis).css("paddingBottom")) || 0;
				height += parseFloat($(pThis).css("borderTopWidth")) || 0;
				height += parseFloat($(pThis).css("borderBottomWidth")) || 0;
				ui.css("top",$(pThis).offset().top+height);	
				ui.show();		
			}
		});
	}	
	,closeDialog:function(){
		if($(this).data("close"))
			$(this).data("close")();
		else if($(this).parents(".dialog") && $(this).parents(".dialog").data("close"))
			$(this).parents(".dialog").data("close")();
	}
	,dialog:function(params){		
		if(!params)
			return;
		if(params.flag && $(".dialog["+params.flag+"]").size()>0)
			return;
			
		var dialog=$("<table class='shadow dialog' "+(params.flag||"")+" border='0' cellspacing='0' cellpadding='0'><tr>  <td class='tl'></td>  <td class='t'></td>  <td class='tr'></td></tr><tr>  <td class='l'></td>  <td class='c'><table class='state-content contentTalbe' border='0' cellspacing='0' cellpadding='0'><tr><td class='caption state-focus'><button class='button'></button></td></tr><tr><td class='body'><div class='content'></div></td></tr><tr><td class='option'><div class='line'></div></td></tr></table></td>  <td class='r'></td></tr><tr>  <td class='bl'></td>  <td class='b'></td>  <td class='br'></td></tr></table>");
		if(params.static)
			dialog.css("position","fixed");
		dialog.find(".caption").html(params.title||"提示");
		
		if(!$(this).is(":visible"))
			$(this).show();		
		
		$(this).appendTo(dialog.find(".content"));
		
		dialog.find(".caption").drag(dialog);
		
		var closeFunc = function(){
			if(dialog.data("overlay")){
				dialog.data("overlay").hide();
				dialog.data("overlay").find("iframe").remove();
				dialog.data("overlay").remove();				
				$.remove(dialog.data("overlay"));				
			}
			dialog.find("iframe").remove();
			dialog.remove();	
			$.remove(dialog);
			return false;
		};
		dialog.close = closeFunc;
		dialog.data("close",closeFunc);
		
		var closeBtn=$("<span class='icon'>x</span>");
		closeBtn.prependTo(dialog.find(".caption"));
		closeBtn.click(function(){
			$(this).closeDialog();
			return false;
		});
		
		if(!params.buttons)
		{
			dialog.data("onOk",params.onOk)
			var trueBtn=$("<button class='button' type='button'>&nbsp;确&nbsp;&nbsp;&nbsp;&nbsp;定&nbsp;</button>");
			trueBtn.appendTo(dialog.find(".option"));
			trueBtn.click(function(){
				var result=true;
				if(dialog.data("onOk"))
					result=dialog.data("onOk")();
				if(result!=false)
					dialog.closeDialog();
			});
			
			dialog.data("onCancel",params.onCancel)
			var cancelBtn=$("<button class='button' type='button'>&nbsp;取&nbsp;&nbsp;&nbsp;&nbsp;消&nbsp;</button>");		
			cancelBtn.appendTo(dialog.find(".option"));		
			cancelBtn.click(function(){
				var result=true;
				if(dialog.data("onCancel"))
					result=dialog.data("onCancel")();
				if(result!=false)
					dialog.closeDialog();	
			});
			
			$("<img align=\"absmiddle\" width=\"20\" src=\""+$.basePath()+"images/icons/Badge-tick.png\"/>").prependTo(trueBtn);
			$("<img align=\"absmiddle\" width=\"20\" src=\""+$.basePath()+"images/icons/Badge-multiply.png\"/>").prependTo(cancelBtn);
		}
		else
		{
			for(var o in params.buttons)
			{
				var btn=$("<button class='button' type='button'>"+o+"</button>");
				btn.appendTo(dialog.find(".option"));
				btn.data("func",params.buttons[o]);
				btn.click(function(){
					$(this).data("func")();
				});
			}
			if(dialog.find(".option button").size()==0)
				dialog.find(".option .line").remove();
		}
		
		if(params.modal==true)
		{
			/*遮罩层*/
			var overlay=$("<div class='overlay'></div>");
			dialog.data("overlay",overlay);
			overlay.css("height",$("body").height());
			overlay.css("z-index",$.zindex());
			overlay.appendTo("body");	
			
			var iframe=$("<iframe border='0' width='100%' height='100%'></iframe>");
			iframe.appendTo(overlay);
		}
		
		dialog.css("z-index",$.zindex());
		
		dialog.appendTo("body");

		dialog.data("onSize",function(runtime){
			if( ($(window).width()-dialog.width()-80) < 0)
				dialog.find(".content").css("width",$(window).width()-80);
			if(($(window).height()-dialog.height()-50) < 0) 
				dialog.find(".content").css("height",$(window).height()-150);
	
			var left = $(window).width()/2-parseInt(dialog.width())/2;
			if(left<10)
				left=10;
			var top = $(window).height()/2-parseInt(dialog.height())/2;
			if(top<0)
				top=0;
			if(!params.static)
				top+=$(window).scrollTop();
			dialog.css("left",(params.left || left)+"px");	
			dialog.css("top",(params.top || top)+"px");
			dialog.css("z-index",$.zindex());
		});	
		
		dialog.data("onSize")();
				
		//设置遮罩层高度
		if(params.modal==true)
			overlay.css("height",$(window).height());
			
		if(params.callback)
			params.callback();
		
		return dialog;
	}	
	/**
	* 验证FORM的并提示
	**/
	,form:function(items,defunc){
		var oForm=$(this).get(0);
		for(var i=0;i<oForm.length;i++ ) 
		{
		   var oItem = oForm[i];
		   if(!oItem)
				continue;
			if($.trim($(oItem).attr("name"))=="")
				continue;
			if($.trim($(oItem).attr("name"))!="" && oItem.type!="hidden" && !$(oItem).parents("dd").find("em").get(0)){
				$(oItem).parents("dd").append("<em></em>");
			}
			oItem.oldTips=$(oItem).parents("dd").find("em").html();
			oItem.funcs=oItem.funcs||[];
			if(items[oItem.name])
				oItem.funcs[oItem.funcs.length] = items[oItem.name];	
			//安装默认的焦点事件
			if(!oItem.defaultFunc){
				oItem.defaultFunc = true;
				$(oItem).blur(
					function(){
						var formtips=$(this).parents("dd").find("em");
						if(this.funcs){
							var allError = "";
							for(var o in this.funcs){
								var func = this.funcs[o];
								var strError=func(this);
								if(strError){
									if(allError!="")
										allError+="<br/>";
									allError+=strError;									
								}
							}
							if(allError!=""){
								formtips.addClass("error");
								formtips.html(allError);
							}
						}
					}
				);			
				$(oItem).focus(
					function(){
						var formtips=$(this).parents("dd").find("em");
						formtips.removeClass("error");
						formtips.html($(this).get(0).oldTips);
					}
				);
			}
		}
		oForm.defunc=defunc;
		/*
		if(!$(this).data("setupSubmited")){
			$(this).data("setupSubmited",true);
			$(this).submit(
				function(){
					return $(this).validForm();
				}
			);
		}*/
		$(this).submit(function(event){
			if(typeof(event.result)!="undefined" && event.result==false)
				return false;
			var result = $(this).validForm();
			if(!(typeof(result)!="undefined" && result==false))
				$.loading(true);	
			return result;	
		});
	}
	/*校验表单*/
	,validForm:function(){
		var oForm=$(this).get(0);
		var noError=true;
		for(var i=0;i<oForm.length;i++ ) 
		{
		    var oItem = oForm[i];
		    if(!oItem)
				continue;
			if($.trim($(oItem).attr("name"))=="")
				continue;
			if($(oItem).attr("novalid"))
				continue;
			var parenter=$(oItem).parents("dd");
		    var formtips=parenter.find("em");
		    		    
		    if(oItem.funcs){
			    var allError = "";
				for(var o in oItem.funcs){
					var func = oItem.funcs[o];
					var strError=func(oItem);
					if(strError){
						if(allError!="")
							allError+="<br/>";
						allError+=strError;	
						noError=false;								
					}
				}
				if(allError!=""){
					formtips.addClass("error");
					formtips.html(allError);
				}
			}
			if(parenter.children("b:contains('*')").length==1)
			{			
				if((/^text|hidden|textarea|file|password|select-one$/.test(oItem.type) && $.trim(oItem.value)=="")||(/^checkbox|radio$/.test(oItem.type) && parenter.find("input:checked").length==0)){
					var strLabel=parenter.prev("dt").html();	
					if(!strLabel)
						strLabel="";					
					if(/^text|textarea|password$/.test(oItem.type))
						formtips.html("请输入"+strLabel.replace(/[\:|：]/g,""));
					else if(/^file|hidden$/.test(oItem.type))
						formtips.html(strLabel.replace(/[\:|：]/g,"")+"不能为空");
					else if(/^select-one|checkbox|radio$/.test(oItem.type))
						formtips.html("请选择"+strLabel.replace(/[\:|：]/g,""));						
					formtips.addClass("error");
					noError=false;
				}
			}
			if(oItem.type=="select-multiple")
				 $(oItem).find("option").attr("selected","selected"); 
		}		
		if(typeof(oForm.defunc)!="undefined"){
			var result = oForm.defunc();
			if(typeof(result)!="undefined" && result!=true)
				noError = false;
		}	
		if(noError==false)
			$.tips("表单验证未通过，不能提交");		
		return noError;	
	}
	/*拖动对象*/
	,drag:function(dest)
	{		
		if($("#drag-css").length==0){
			var css="<style id='drag-css'>";
			css+=".dragmask{cursor:pointer;display:none;position:fixed;z-index:999999999999999;bottom:0px;left:0px; width:100%; height:100%;background:#000000;filter:alpha(opacity=1);opacity: 0.01;}";
			css+="</style>";
			$(css).appendTo("head");
			$("<div class='dragmask'></div>").appendTo("body");
		}
		var w=dest.width();
		var h=dest.height();
		
		var iWidth = $(window).width();
		var iHeight = $(window).height();		
		
		var pThis = $(this);
		$(this).mousedown(function(event) {
			if(event.target!=pThis.get(0) && $(event.target).parents(pThis).size()==0)return;
			var evt = getEvent();
			dest.data("moveable",true);
			dest.data("startX",evt.clientX);
			dest.data("startY",evt.clientY);
			dest.data("startLeft",parseInt(dest.css("left")));
			dest.data("startTop",parseInt(dest.css("top")));
			dest.data("startRight",parseInt(dest.css("right")));
			dest.data("startBottom",parseInt(dest.css("bottom")));	
			w=dest.width();
			h=dest.height();
		});
		
		$(document).mousemove(function() {
			if (dest.data("moveable")==true) {				
				var evt = getEvent();
				if(!isNaN(dest.data("startLeft")) && !isNaN(dest.data("startTop"))){
					var x = dest.data("startLeft") + evt.clientX - dest.data("startX");
					var y = dest.data("startTop") + evt.clientY - dest.data("startY");
					//if ( x > 0 &&( x + w < iWidth) )
						dest.css("left",x);
					if ( y >= -8 && (y+28) < iHeight )//&& (y + h < iHeight) 
						dest.css("top",y);
				}
				if(!isNaN(dest.data("startRight")) && !isNaN(dest.data("startBottom"))){
					var x = dest.data("startRight") - (evt.clientX - dest.data("startX"));
					var y = dest.data("startBottom") - (evt.clientY - dest.data("startY"));
					//if ( x > 0 &&( x + w < iWidth) )
					dest.css("right",x);
					dest.css("bottom",y);
				}
				$(".dragmask").show();
			}
		});
	
		$(document).mouseup(function () {
			dest.data("moveable",false);
			$(".dragmask").hide();
		});
		
		// 获得事件Event对象，用于兼容IE和FireFox
		function getEvent() {
			return window.event || arguments.callee.caller.arguments[0];
		}
	}
	/*透明化ie6下的png*/
	,pngFix:function(settings) {
		// Settings
		settings = jQuery.extend({
			blankgif: 'blank.gif'
		}, settings);
	
		var ie55 = (navigator.appName == "Microsoft Internet Explorer" && parseInt(navigator.appVersion) == 4 && navigator.appVersion.indexOf("MSIE 5.5") != -1);
		var ie6 = (navigator.appName == "Microsoft Internet Explorer" && parseInt(navigator.appVersion) == 4 && navigator.appVersion.indexOf("MSIE 6.0") != -1);
	
		if (jQuery.browser.msie && (ie55 || ie6)) {
	
			//fix images with png-source
			jQuery(this).find("img[src$=.png]").each(function() {
	
				jQuery(this).attr('width',jQuery(this).width());
				jQuery(this).attr('height',jQuery(this).height());
	
				var prevStyle = '';
				var strNewHTML = '';
				var imgId = (jQuery(this).attr('id')) ? 'id="' + jQuery(this).attr('id') + '" ' : '';
				var imgClass = (jQuery(this).attr('class')) ? 'class="' + jQuery(this).attr('class') + '" ' : '';
				var imgTitle = (jQuery(this).attr('title')) ? 'title="' + jQuery(this).attr('title') + '" ' : '';
				var imgAlt = (jQuery(this).attr('alt')) ? 'alt="' + jQuery(this).attr('alt') + '" ' : '';
				var imgAlign = (jQuery(this).attr('align')) ? 'float:' + jQuery(this).attr('align') + ';' : '';
				var imgHand = (jQuery(this).parent().attr('href')) ? 'cursor:hand;' : '';
				if (this.style.border) {
					prevStyle += 'border:'+this.style.border+';';
					this.style.border = '';
				}
				if (this.style.padding) {
					prevStyle += 'padding:'+this.style.padding+';';
					this.style.padding = '';
				}
				if (this.style.margin) {
					prevStyle += 'margin:'+this.style.margin+';';
					this.style.margin = '';
				}
				var imgStyle = (this.style.cssText);
	
				strNewHTML += '<span '+imgId+imgClass+imgTitle+imgAlt;
				strNewHTML += 'style="position:relative;white-space:pre-line;display:inline-block;background:transparent;'+imgAlign+imgHand;
				strNewHTML += 'width:' + jQuery(this).width() + 'px;' + 'height:' + jQuery(this).height() + 'px;';
				strNewHTML += 'filter:progid:DXImageTransform.Microsoft.AlphaImageLoader' + '(src=\'' + jQuery(this).attr('src') + '\', sizingMethod=\'scale\');';
				strNewHTML += imgStyle+'"></span>';
				if (prevStyle != ''){
					strNewHTML = '<span style="position:relative;display:inline-block;'+prevStyle+imgHand+'width:' + jQuery(this).width() + 'px;' + 'height:' + jQuery(this).height() + 'px;'+'">' + strNewHTML + '</span>';
				}
	
				jQuery(this).hide();
				jQuery(this).after(strNewHTML);
	
			});
	
			// fix css background pngs
			jQuery(this).find("*").each(function(){
				var bgIMG = jQuery(this).css('background-image');
				if(bgIMG.indexOf(".png")!=-1){
					var iebg = bgIMG.split('url("')[1].split('")')[0];
					jQuery(this).css('background-image', 'none');
					jQuery(this).get(0).runtimeStyle.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(src='" + iebg + "',sizingMethod='scale')";
				}
			});
			
			//fix input with png-source
			jQuery(this).find("input[src$=.png]").each(function() {
				var bgIMG = jQuery(this).attr('src');
				jQuery(this).get(0).runtimeStyle.filter = 'progid:DXImageTransform.Microsoft.AlphaImageLoader' + '(src=\'' + bgIMG + '\', sizingMethod=\'scale\');';
			jQuery(this).attr('src', settings.blankgif)
			});
		
		}
	}
	//iframe自适应内容高度
	,autoHeight:function(){
		var contentframe = $(this);
		var frame = $(this).get(0);		
		if($(frame.contentWindow.document).size()){
			contentframe.attr("height",0);
			contentframe.css("height","0px");
			var framedocument = $(frame.contentWindow.document);
			var setheight = framedocument.height();	
			if(framedocument.width()>$(window).width())
				setheight+=20;
			setheight+=10;
			contentframe.attr("height",setheight);
			contentframe.css("height",setheight+"px");
			/*if(contentframe.is(":visible") && framedocument.height()>framedocument.find("body").height()){
				var height = framedocument.height()+(framedocument.height()-framedocument.find("body").height());
				contentframe.attr("height",height);
				contentframe.css("height",height+"px");
			}*/
		}
	}
	//iframe自适应内容宽度
	,autoWidth:function(){
		var contentframe = $(this);
		var frame = $(this).get(0);
		if($(frame.contentWindow.document).size()){
			var framedocument = $(frame.contentWindow.document);
			contentframe.attr("width",framedocument.width());
			if(framedocument.width()>framedocument.find("body").width())
				contentframe.attr("width",framedocument.width()+(framedocument.width()-framedocument.find("body").width()));
		}
	}
	/**
	* 显示一个工具提示框
	**/
	,tooltip:function(html,dir,callback,time){
		if(typeof(dir)=="function"){
			callback=dir;
			dir = null;
		}
		if(typeof(dir)=="number"){
			time=dir;
			dir = null;
		}
		var pThis = $(this);
		if(pThis.size()==0)
			return;
		if(!pThis.is(":visible"))
			pThis = pThis.parents("*:visible");
			
		$(".tooltip").each(function(){
			$(this).data("close")();
		});
			
		var tooltip=$("<table class='tooltip shadow' border='0' cellspacing='0' cellpadding='0'><tr>  <td class='tl'></td>  <td class='t'></td>  <td class='tr'></td></tr><tr>  <td class='l'></td>  <td class='c'><table class='state-content contentTalbe' border='0' cellspacing='0' cellpadding='0'><tr><td class='body'><div class='arr'><div class='ab'></div><div class='ba'></div></div><div class='cnt'></div></td></tr></table></td>  <td class='r'></td></tr><tr>  <td class='bl'></td>  <td class='b'></td>  <td class='br'></td></tr></table>");
		tooltip.css("position","absolute");//.css("z-index",$.zindex());
		tooltip.find(".cnt").html(html);
		tooltip.appendTo("body");
		
		$("<a class='closer' href='javascript:void(0);'>X</a>").prependTo(tooltip.find(".cnt")).click(function(){
			pThis.data("close")();
		});
		
		//根据当前对象分析出显示的位置
		{
			var offset = pThis.offset();
			offset.right=$(window).width()-offset.left-pThis.width();
			offset.bottom=$(window).height()-offset.top-pThis.height();
			offset.center = offset.left+pThis.width()/2;
			offset.middle = offset.top+pThis.height()/2;
			var postype = "";
			if((offset.center-tooltip.width()/2)>0){//上下
				if(offset.bottom>offset.top){//上
					postype="top";				
				}else{//下
					postype="bottom";
				}
			}else if((offset.middle-tooltip.height()/2)>0){//左右
				if(offset.right>offset.left){//左
					postype="left";
				}else{//右
					postype="right";
				}
			}
			
			if(dir)
				postype=dir;
			
			if(postype=="top")
				tooltip.offset({
					left:(offset.center-tooltip.width()/2),
					top:offset.top+pThis.height()
				});	
			if(postype=="bottom")
				tooltip.offset({
					left:(offset.center-tooltip.width()/2),
					top:offset.top-tooltip.height()
				});
			if(postype=="left")
				tooltip.offset({
					left:offset.left+pThis.width(),
					top:(offset.middle-tooltip.height()/2)
				});
			if(postype=="right")
				tooltip.offset({
					left:offset.left-tooltip.width(),
					top:(offset.middle-tooltip.height()/2)
				});
			
			tooltip.find(".arr").addClass(postype);
			//tooltip.css("z-index",$.zindex());
		}
		var closeTooltip=function(){
			tooltip.remove();
			$.remove(tooltip);
			if(callback)
				callback();
			$("body").unbind("click",closeTooltip);
		};
		tooltip.data("close",closeTooltip);
		tooltip.one("click",closeTooltip);
		
		if(time){
			setTimeout(closeTooltip,time);
		}
		
		return tooltip;
	}
	,say:function(html,dir,callback,time){
		return $(this).tooltip(html,dir,callback,time);
	}
});


$.extend({
	//js远程调用服务器函数
	//$(类名,函数)(参数...)
	//参数以服务器函数的参数为准，如果服务器的参数是Map,则以{...}作为参数
	api:function(className,methodName,callback){
		return function(){
			var params={
				className:className,
				methodName:methodName
			};
			for(var i=0;i<arguments.length;i++)
				params["$"+i]=typeof(arguments[i])=="object"?JSON.stringify(arguments[i]):arguments[i];
			var jsonString=$.ajax({
			   type: "POST",
			   dataType:"json",
			   url:window.apiUrl||window.top.apiUrl,
			   data:params,
			   cache:false,
			   async:callback?true:false,
			   success:callback
			}).responseText;
			return eval("("+jsonString+")");
		}
	},
	//提交数据到某url
	submit:function(url,data,target){
		var form = $("#tempPostForm");
		if(form.size()==0)
			form=$("<form id='tempPostForm' name='tempPostForm'></form>").appendTo("body").hide();
		form.attr("action",url).attr("method","post").attr("target",target?target:"_self");
		form.empty();
		for(var o in data){
			var value = data[o];
			if(value instanceof Array){ 
				for(var p in value){
					$("<input type='hidden'/>").val(value[p]).attr("name",o).appendTo(form);
				}
			}else{
				if(typeof(value)=="object")
					value = JSON.stringify(value);
				$("<input type='hidden'/>").val(value).attr("name",o).appendTo(form); 
			}
		}
		form.submit();
	},
	loading:function(bShow){
		if(!bShow){
			$(".loading").remove();
			return;
		}else{
			/*遮罩层*/
			var loading=$("<div class='loading'><div class='mask'></div><div class='icon'></div></div>");
			loading.css("height",$("body").height());
			loading.css("z-index",99999999999);
			loading.appendTo("body");			
			$("<iframe border='0' width='100%' height='100%'></iframe>").appendTo(loading.find(".mask"));
			return loading;
		}
	},
	//远程获取ajax对象
	getObject:function(url,params,callback,error){
		var jsonString=$.ajax({
		   type: "POST",
		   dataType:(url.indexOf("=?")>-1)?"jsonp":"json",
		   url:url,
		   data:params,
		   cache:false,
		   async:callback?true:false,
		   success:callback,
		   error:error
		}).responseText;
		return eval("("+jsonString+")");
	},
	//字段选择器{className,selected,callback,title}
	getFields:function(params){
		var selmap = {};
		if(typeof(params.selected)=="object"){
			selmap = params.selected;
		}else if(typeof(params.selected)=="string"){
			var array = params.selected.split(",");
			for(var o in array)
				selmap[$.trim(array[o])]=true;
		}else if(typeof(params.selected)=="array"){
			var array = params.selected;
			for(var o in array)
				selmap[$.trim(array[o])]=true;
		}
		var lastes = {};
		if(typeof(params.lasteres)=="object"){
			lastes = params.lasteres;
		}else if(typeof(params.lasteres)=="string"){
			var array = params.lasteres.split(",");
			for(var o in array)
				lastes[$.trim(array[o])]=true;
		}else if(typeof(params.lasteres)=="array"){
			var array = params.lasteres;
			for(var o in array)
				lastes[$.trim(array[o])]=true;
		}
		$.getObject(window.contextPath+"export.do",{depth:(params.depth||"0"),struct:true,className:params.className},function(classFields){
			var strHtml = "";
			strHtml+="<table id=\"classTree\" width=\"320\" class=\"table\" border=\"0\" cellspacing=\"1\" cellpadding=\"0\">";
			strHtml+="<thead class='state-header'>";
			strHtml+="<tr>";
			strHtml+="<td align='right'>";
			strHtml+="<a class='A' href='javascript:void(0);' style='margin:0px 5px;'>上次</a>";
			strHtml+="<a class='B' href='javascript:void(0);' style='margin:0px 5px;'>全选</a>";
			strHtml+="<a class='C' href='javascript:void(0);' style='margin:0px 5px;'>清空</a>";
			strHtml+="</td>";
			strHtml+="</tr>";
			strHtml+="</thead>";
			strHtml+="<tbody>";
			for(var o in classFields){
				var item = classFields[o];
				strHtml+="<tr id=\""+item.name+"\" tree=\""+(item.parent||"0")+"\">";
				strHtml+="<td class=\"node\">";
				strHtml+="<input class=\"keys\" note='"+(item.note||"")+"' classtype='"+item.type+"' name=\"keys\" "+(selmap[item.name] ? "checked='checked'" : "")+" type=\"checkbox\" value=\""+item.name+"\" val=\""+item.name+"\" text=\""+item.caption+"\"/>";
				strHtml+=item.caption;
				strHtml+="</td>";
				strHtml+="</tr>";
			}
			strHtml+="</tbody>";
			strHtml+="</table>";
			var dialog = top.$(strHtml).dialog({
				title:params.title||"选择列",
				modal:true,
				onOk:function(){//以传入的selected类型返回所选
					if(typeof(params.selected)=="object"){
						var fields={};
						dialog.find(".keys").each(function(){
							if($(this).is(":checked"))
								fields[$(this).val()]=$(this).attr("text");
						});
						params.callback(fields,dialog);
					}else if(typeof(params.selected)=="array"){
						var fields=[];
						dialog.find(".keys").each(function(){
							if($(this).is(":checked"))
								fields[fields.length]=$(this).val();
						});
						params.callback(fields,dialog);
					}else{
						var fields="";
						dialog.find(".keys").each(function(){
							if($(this).is(":checked"))
								fields+=(fields==""?"":",")+$(this).val();
						});
						params.callback(fields,dialog);
					}
				}
			});
			dialog.find(".state-header .A").click(function(){
				dialog.find(".keys").attr("checked",false);
				for(var o in lastes){
					dialog.find(".keys[val='"+o+"']").attr("checked",true);
				}
			});
			dialog.find(".state-header .B").click(function(){
				dialog.find("tr[tree='0'] .keys").attr("checked",true);
			});
			dialog.find(".state-header .C").click(function(){
				dialog.find(".keys").attr("checked",false);
			});
			dialog.find("#classTree").treegrid({expand:true});
			dialog.find("#classTree").parent().width(dialog.find("#classTree").width()+25);
			dialog.find("#classTree").parent().height($(top.window).height()/3*2);
			dialog.data("onSize")();
		});	
	},
	/*
	* 内容输入对话框,
	* @param type:text number select checkbox,grid,combox等
			如果是select,checkbox,radio等，需要传入items:{name:value,...}
	* @callback 回调函数
	* @value 默认参数
	*/
	getInput:function(params){
		params=params||{};
		if(!params.type)params.type="text";
		if(!params.callback){
			$.tips("未指该输入的回调函数");
			return;
		}
		//根据类型创建输入框//////////////////////
		var strHtml = "";
		if(params.type=="text")//文本框
			strHtml = "<input style='width:200px;"+($.trim(params.style))+"' name='getContentInput' type='text' class='input'/>";
		else if(params.type=="number")//整数
			strHtml = "<input style='width:200px;"+($.trim(params.style))+"' onkeyup=\"this.value=this.value.replace(/[^\d]/g,'')\" name='getContentInput' type='text' class='input'/>";
		else if(params.type=="money")//小数
			strHtml = "<input style='width:200px;"+($.trim(params.style))+"' onkeyup=\"var reg=/^-?(([1-9]\\d{0,9})|0)?(\\.)?(\\d+)?/;this.value=this.value.match(reg)?this.value.match(reg)[0]:''\" name='getContentInput' type='text' class='input'/>";
		else if(params.type=="date")//日期
			strHtml = "<input style='width:200px;"+($.trim(params.style))+"' onclick=\"WdatePicker({dateFmt:'yyyy-MM-dd'})\" name='getContentInput' type='text' class='input'/>";
		else if(params.type=="datetime")//日期时间
			strHtml = "<input style='width:200px;"+($.trim(params.style))+"' onclick=\"WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})\" name='getContentInput' type='text' class='input'/>";
		else if(params.type=="time")//时间
			strHtml = "<input style='width:200px;"+($.trim(params.style))+"' onclick=\"WdatePicker({dateFmt:'HH:mm:ss'})\" name='getContentInput' type='text' class='input'/>";
		else if(params.type=="textarea")//多行文本
			strHtml = "<textarea style='width:500px;height:120px;"+($.trim(params.style))+"' name='getContentInput' class='input'></textarea>";
		else if(params.type=="combox"){//动态查询
			strHtml = "<input action='"+params.action+"' title=\"请输入"+params.title+"进行查询\" class=\"combox narrow\"  type=\"text\" name='getContentInput' value=''/>";
		}
		else if(params.type=="select"){//下拉框
			strHtml = "<select style='width:200px;"+($.trim(params.style))+"' name='getContentInput'>";
			for(var o in params.items){
				strHtml+="<option "+(params.selected==params.items[o]?"selected":"")+" value='"+params.items[o]+"'>"+o+"</option>";
			}
			strHtml+="</select>";
		}else if(params.type=="checkbox"){//多选项
			strHtml = "<div style='width:500px;"+($.trim(params.style))+"'>";
			for(var o in params.items){
				strHtml+="<label><input name='getContentInput' type='checkbox'/></label>";
			}
			strHtml+="</div>";
		}else if(params.type=="radio"){//单选项
			strHtml = "<div style='width:500px;"+($.trim(params.style))+"'>";
			for(var o in params.items){
				strHtml+="<label><input name='getContentInput' type='radio'/></label>";
			}
			strHtml+="</div>";
		}else if(params.type=="image"){//获取图片
			strHtml += "图片地址：<input style='width:300px;"+($.trim(params.style))+"' id='getContentInput' name='getContentInput' type='text' class='input'/>";
			strHtml += "&nbsp;&nbsp;&nbsp;或者：<button onclick=\"$.upload({type:'img',callback:function(url){if(url)$('#getContentInput').val(url)}})\" type='button' class='button'>上传图片</button>";
		}
		var dialog = $.dialog({
			modal:true,
			title:params.title||"请输入内容",
			html:strHtml,
			onOk:function(){
				var strValue="";
				var strText = "";
				if(params.type=="combox"){
					strValue = dialog.find("[name='getContentInput']").val();
					strText = dialog.find("[name='getContentInput']").attr("text");
				}if(params.type=="checkbox"||params.type=="radio"){
					dialog.find("[name='getContentInput']").each(function(){
						if($(this).is(":checked")){
							strValue+=(strValue==""?"":",")+$(this).val();
						}
					});
				}else{
					strValue = dialog.find("[name='getContentInput']").val();
				}					
				if($.trim(strValue)=="")
					return $.tips("请输入内容");
				params.callback(strValue,strText);
				dialog.closeDialog();
			}
		});	
		if(params.type=="combox"){
			dialog.find("[name='getContentInput']").combox();	
			dialog.find(".content").css("overflow","visible");				
		}	
		
		//根据初始值初始化值//////////////////////
		if(typeof(params.value)!="undefined"){
			if(params.type=="checkbox"||params.type=="radio"){
				var array = (""+params.value).split(",");
				dialog.find("[name='getContentInput']").each(function(){
					for(var o in array){
						if(array[o]==$(this).val())
							$(this).attr("checked",true);
					}
				});					
			}else{
				dialog.find("[name='getContentInput']").val(params.value);
			}
		}
	},
	/*
	* 表格输入对话框,
	* @param columns {name:{width,input}}  input支持[text,number,money,date,datetime,time,select]如果是select，需要传入items:{name:value,...}
	* @values 默认参数，传入一个二维数组，对应每列
	* @callback 回调函数	
	* @dialogParmas 对话框的参数
	*/
	getGrid:function(columns,values,callback,dialogParmas){
		var strHtml = "";
		strHtml="<table class=\"table\" border=\"0\" cellspacing=\"1\" cellpadding=\"0\">";
		strHtml+="<thead class=\"state-header\"><tr>";
		for(var o in columns){
			var strInput = columns[o].input ? (" input=\""+(columns[o].input)+"\" ") : "";
			var strItems = columns[o].items ? (" items=\""+JSON.stringify(columns[o].items).replace(/[\"]/g,"'")+"\" "):"";
			strHtml+="<td width='"+(columns[o].width||120)+"' "+strInput+strItems+">"+o+"</td>";
		}
		strHtml+="<td width='80'><a class='add' href='javascript:void(0)'>添加</a></td>";
		strHtml+="</tr></thead><tbody></tbody></table>";
		
		//生成对话框
		dialogParmas = dialogParmas || {};
		var dialog = $.dialog({
			modal:true,
			title:dialogParmas.title||"请输入内容",
			html:strHtml,
			onOk:function(){
				var strValue="";				
				callback(strValue);
				dialog.closeDialog();
			}
		});		
		
		//安装控件事件及方法
		dialog.addGridItem=function(arr){
			var sHtml = "<tr>";
			var count = dialog.find(".table thead td").size()-1;
			if(arr)count = arr.length;				
			for(var j=0;j<count;j++){
				sHtml+="<td>"+(arr ? arr[j] : " ")+"</td>";
			}
			sHtml+="<td align='center'><a class='del' href='javascript:void(0)'>删除</a></td>";
			sHtml+= "</tr>";
			$(sHtml).appendTo(dialog.find(".table tbody")).find(".del").click(function(){
				$(this).parents("tr:eq(0)").remove();
			});
		}			
		dialog.find(".table .add").click(function(){
			dialog.addGridItem();
		});
		
		//当点击表格时进入编辑模式
		dialog.find(".table").editable();
		
		//初始化表格数据
		var array = values;
		for(var i=0;i<array.length;i++){
			dialog.addGridItem(array[i]);
		}
	},
	/**
	* 创建输入框并返回
	**/
	createInput:function(inputtype,formName,options,value,change){
		if(inputtype=="text"){
			var input = $("<input novalid='true' class='txt' type='text'/>").attr("name",formName).val(value);
			/*input.click(function(){
				$(this).select();
			});*/
			if(change){
				input.blur(function(){
					change($(this));
				});
			}
			return input;
		}
		if(inputtype=="image"){
			var input = $("<input novalid='true' class='txt' type='text'/>").attr("name",formName).val(value);
			input.click(function(){
				$.upload({
					type:"img",
					callback:function(url){
						if(url)input.val(url);
					}
				});
			});
			if(change){
				input.blur(function(){
					change($(this));
				});
			}
			return input;
		}
		if(inputtype=="textarea"){
			var input = $("<textarea novalid='true' class='txt'></textarea>").attr("name",formName).val(value);
			/*input.click(function(){
				$(this).select();
			});*/
			if(change){
				input.blur(function(){
					change($(this));
				});
			}
			return input;
		}
		if(inputtype=="hidden"){
			var input = $("<input novalid='true' type='hidden'/>").attr("name",formName).val(value);
			return input;
		}
		if(inputtype=="number"){
			var input = $("<input novalid='true' class='txt' type='text'/>").attr("name",formName).val(value);
			input.click(function(){
				$(this).select();
			});
			input.keyup(function(){
				$(this).val($(this).val().replace(/[^\d]/g,''))
			});
			if(change){
				input.change(function(){
					change($(this));
				});
			}
			return input;
		}
		if(inputtype=="menoy"){
			var input = $("<input novalid='true' class='txt' type='text'/>").attr("name",formName).val(value);
			input.click(function(){
				$(this).select();
			});
			input.keyup(function(){
				var reg=/^-?(([1-9]\d{0,9})|0)?(\.)?(\d+)?/;
				this.value=this.value.match(reg)?this.value.match(reg)[0]:'';
			});
			if(change){
				input.change(function(){
					change($(this));
				});
			}
			return input;
		}
		if(inputtype=="date"){
			var input = $("<input novalid='true' class='txt' type='text'/>").attr("name",formName).val(value);
			input.click(function(){
				WdatePicker({dateFmt:'yyyy-MM-dd'});
			});
			if(change){
				input.blur(function(){
					change(input);
				});
			}
			return input;
		}
		if(inputtype=="datetime"){
			var input = $("<input novalid='true' class='txt' type='text'/>").attr("name",formName).val(value);
			input.click(function(){
				WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'});
			});
			if(change){
				input.blur(function(){
					change(input);
				});
			}
			return input;
		}
		if(inputtype=="select"){
			var select = $("<select novalid='true'></select>").attr("name",formName).val(value);
			for(var o in options){
				var option = $("<option "+(value==options[o].value?"selected":"")+"></option>").appendTo(select);
				option.text(options[o].text).attr("value",options[o].value);
				option.data("data",options[o]);
			}
			if(change){
				select.change(function(){
					change($(this));
				});
			}
			return select;
		}
		if(inputtype=="query"){
			var input = $("<input novalid='true' class='txt' type='text'/>").attr("name",formName).val(value);
			input.attr("action",options);
			input.click(function(){
				var combox = input.combox();
				var td = combox.parents("td");
				combox.find(".face,.face span,.face button").height(td.height()).css("line-height",td.height()+"px");
				combox.find(".face button").css("margin","0px");
				td.css("overflow","visible");
				if(change){
					combox.change(function(){
						change(combox.find("input[type='hidden']"));
					});
				};
				setTimeout(function(){
					combox.find(".face").click();
				},300);
			});
			return input;
		}
		if(inputtype=="checkbox"){
			var div = $("<div></div>");
			var arr = value.split(",");
			var values = {};
			for(var o in arr)
				values[arr[o]]=true;
			for(var o in options){
				var label = $("<label>"+options[o].text+"</label>").appendTo(div);
				label.text($.trim(values[options[o].text]));
				var checkbox = $("<input novalid='true' style='margin:8px auto;' valign='middle' name='"+formName+"' "+(values[options[o].value]?"checked":"")+" type='checkbox' value='"+options[o].value+"'/>").prependTo(label);
				checkbox.data("data",options[o]);
				if(change){
					checkbox.click(function(){
						change($(this));
					});
				}
			}
			return div;
		}
		if(inputtype=="grid"){
			var input = $("<input class='txt' novalid='true' gridinput='true' readonly='readonly' type='text'/>").attr("title",value||"").attr("name",formName);
			if(typeof(value)!="undefined" && $.trim(value)!="")
				input.val(JSON.stringify(value));
			input.click(function(){
				//有可能传入的结构参数就是grid需要的结构参数，否则把options转成grid参数结构
				var isConvert = false;
				if(!options.column){
					var columnOptions = {column:[]}
					for(var o in options){
						columnOptions.column[columnOptions.column.length]=[
							options[o].text,80,"text",options[o].value
						];
					}
					options = columnOptions;
					isConvert = true;
				}
				var grid=$("<div style='"+(isConvert?"width:300px;height:160px;":"width:620px;height:300px;")+"margin-right:25px;'></div>").grid(options);
				var dialog = grid.dialog({
					modal:true,
					title:"编辑列表项值",
					onOk:function(){
						var notEmpty = true;
						grid.find("[name]").each(function(){
							if($(this).val()=="" && !$(this).attr("gridinput") && $(this).attr("type")!="hidden")
								notEmpty = false;
						});
						if(!notEmpty){
							$.toast("列表项名称或值不能为空");
							return false;
						}
						var optionValue = grid.getValue();
						input.val(optionValue).attr("title",optionValue);
						if(change){
							change(input,optionValue);
						}
					}
				});
				var values = $.trim(input.val())==""?[]:eval("("+input.val()+")");
				grid.setValue(values);
			});
			if(change){
				input.change(function(){
					change($(this));
				});
			}
			return input;
		}
	},
	//文件上传对话框
	upload:function(params){	
		params=params||{};
		params.app=params.app || "attached";
		if(!params.callback){
			$.tips("未指该上传的回调函数");
			return;
		}
		if(!params.type){
			$.tips("未指该上传的类型 img或file");
			return;
		}
		params.count=params.count || 1;
		
		if(params.width && params.height && params.type=="img" && params.count==1)
			return $.crop(params.callback,params.width,params.height);
			
		var flag="flag"+$.UUID();
		
		var uploadTemplate=
			"<div id='"+flag+"Lazy3qUploadDiv'>"+
			"	<div>"+
			"		<table border='0' cellspacing='5' cellpadding='5'><tr><td>"+
			"		<object id='"+flag+"Lazy3qUpload' name='"+flag+"Lazy3qUpload' classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000' codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,19,0' width='78' height='26'>"+
			"			<param name='movie' value='"+(window["lzFlashUrl"]||($.contextPath()+"flash/"))+"Lazy3qUpload.swf' />"+
			" 			<param name='FlashVars' value='callback="+flag+"Callback&config="+flag+"Config' />"+
			"			<param name='quality' value='high' />"+
			" 			<param name='allowScriptAccess' value='always' />"+
			" 			<embed src='"+(window["lzFlashUrl"]||($.contextPath()+"flash/"))+"Lazy3qUpload.swf' allowScriptAccess='always' FlashVars='callback="+flag+"Callback&config="+flag+"Config' quality='high' pluginspage='http://www.macromedia.com/go/getflashplayer' type='application/x-shockwave-flash' width='78' height='26'></embed>"+
			"		</object>"+
			"		</td><td>请选择要上传的文件,文件最大不能超过2M</td></tr></table>"+
			"	</div>"+
			"	<div id='"+flag+"Lazy3qUploadProgress'>"+
			"	</div>"+
			"</div>";
		var fileType=[];
		if(params.type=="img")
			fileType=["*.png;*.jpg;*.gif;","图片文件"];
		else if(params.type=="file")
			fileType=["*.*;","所有文件"];
		else
			fileType=[params.type.split("|")[1],params.type.split("|")[0]];
		window[flag+"Config"]=function(){
			return {
				types:[fileType],						
				multi:params.count>1?true:false,
				filedata:"file",
				url:window["uploadUrl"]
			};
		};
		window[flag+"Callback"]=function(id,file,info){
			if(info.type=="start"){
				if(params.count==1)
					$("#"+flag+"Lazy3qUploadProgress").empty();
				var progress=$("<div></div>").attr("id",id).appendTo($("#"+flag+"Lazy3qUploadProgress"));
				var delbtn=$("<a href='javascript:void(0);'>取消</a>").appendTo(progress);
				var span=$("<span></span>").appendTo(progress);
				var input=$("<input type='hidden' value=''></input>").appendTo(progress);
				span.html(file.name+"["+$.sizeFormat(file.size)+"]   准备上传");
				progress.children().css("margin-left","10px");
				delbtn.click(function(){
					$("#"+id).remove();
				});
			}
			else if(info.type=="progress"){
				$("#"+id).find("span").html(file.name+"["+$.sizeFormat(file.size)+"]   已经上传"+Math.floor(info.bytesLoaded/info.bytesTotal*100)+"%");
			}
			else if(info.type=="uploadCompleteData"){
				if(info.message)
					$("#"+id).find("span").html(file.name+"["+$.sizeFormat(file.size)+"]   "+info.message);
				if(info.error==0 && info.url){
					$("#"+id).find("span").html(file.name+"["+$.sizeFormat(file.size)+"]   文件上传成功");
					$("#"+id).find("input").val(info.url);
				}
			}
			return true;
		};
		window[flag+"Dialog"]=$.dialog({
			title:"上传文件",
			html:uploadTemplate,
			modal:true,
			onOk:function(){
				if($("#"+flag+"Lazy3qUploadProgress").children().size()<1){
					$.tips("没有上传文件.");
					return false;
				}
				if($("#"+flag+"Lazy3qUploadProgress input[value='']").size()>0){
					$.tips("上传正在进行.");
					return false;
				}
				var inputs=$("#"+flag+"Lazy3qUploadProgress input");
				$.each(inputs,function(i,o){
					params.callback($(o).val());				
				});
				return true;
			}
		});	
	},
	//上传并裁切图片
	crop:function(callback,width,height){
		var flag="flag"+$.UUID();
		top.window[flag+"Config"]=function(){
			return {
				url:window["uploadUrl"],
				filedata:"file",
				width:width,
				height:height
			}
		};
		top.window[flag+"Callback"]=function(id,info){
			if(info && info.url)
				callback(info.url);
			if(info && info.error==1 && info.message)
				$.tips(info.message);
			window[flag+"Dialog"].close();
		};
		var imgEditorHtml=
			"<object id='"+flag+"Lazy3qImageEditor' name='"+flag+"Lazy3qImageEditor' classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000' codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,19,0' width='"+(width+250)+"' height='"+(height+200)+"'>"+
			"	<param name='movie' value='"+(window["lzFlashUrl"]||($.contextPath()+"flash/"))+"Lazy3qImageEditor.swf' />"+
			" 	<param name='FlashVars' value='callback="+flag+"Callback&config="+flag+"Config' />"+
			"	<param name='quality' value='high' />"+
			"   <param name='wmode' value='transparent'/>"+
			" 	<param name='allowScriptAccess' value='always' />"+
			" 	<embed src='"+(window["lzFlashUrl"]||($.contextPath()+"flash/"))+"Lazy3qImageEditor.swf' wmode='transparent' allowScriptAccess='always' FlashVars='callback="+flag+"Callback&config="+flag+"Config' quality='high' pluginspage='http://www.macromedia.com/go/getflashplayer' type='application/x-shockwave-flash' width='"+(width+250)+"' height='"+(height+200)+"'></embed>"+
			"</object>";
		
		window[flag+"Dialog"]=top.$.dialog({
			title:"在线图片编辑",
			html:imgEditorHtml,
			modal:true,
			buttons:[]
		});
		/*20120919改:因为上传并裁切图片的对话框可能很大，改成层模式*/
		/*if($("#croplayer-css").length==0){
			var css="<style id='croplayer-css'>";
			css+=".croplayer{position:absolute;left:0px;top:0px;width:100%;height:100%}";
			css+="</style>";
			$(css).appendTo("head");
		}
		var table=$("<table class='croplayer state-content' border='0' cellspacing='0' cellpadding='0'><tr><td align='center'></td></tr></table>");
		table.appendTo("body").css("z-index",$.zindex()).height($(document).height());
		table.find("td").html(imgEditorHtml);
		window[flag+"Dialog"]=table;*/
	},
	/**
	* 全窗口模式编辑思维导图
	**/
	mind:function(userConfig,paints,callback){
		var editable = true;//是否可编辑
		var size = {width:$(window).width(),height:$(window).height()};
		//在源对象处插入一个不可编辑的思维导图
		var wrap = $("<div style=\"width:100%;height:100%;top:0px;left:0px;position:fixed;z-index:"+$.zindex()+";\"></div>").appendTo("body");
		var flag="flag"+$.UUID();
		var mindTemplate=
		"<div id='"+flag+"MindDiv'>"+
		"		<object id='"+flag+"Mind' name='"+flag+"Mind' classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000' codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=7,0,19,0' width='"+size.width+"' height='"+size.height+"'>"+
		"			<param name='movie' value='"+(window["lzFlashUrl"]||($.contextPath()+"flash/"))+"mind.swf?mm="+flag+"' />"+
		" 			<param name='FlashVars' value='config="+flag+"Config' />"+
		"			<param name='quality' value='high' />"+
		" 			<param name='allowScriptAccess' value='always' />"+
		" 			<param name='allowNetworking' value='all' />"+
		" 			<param name='allowFullScreen' value='true' />"+
		" 			<param name='wmode' value='transparent' />"+
		" 			<embed id='"+flag+"Mind' name='"+flag+"Mind' src='"+(window["lzFlashUrl"]||($.contextPath()+"flash/"))+"mind.swf?mm="+flag+"' allowNetworking='all' allowFullScreen='true' wmode='transparent' allowScriptAccess='always' FlashVars='config="+flag+"Config' quality='high' pluginspage='http://www.macromedia.com/go/getflashplayer' type='application/x-shockwave-flash' width='"+size.width+"' height='"+size.height+"'></embed>"+
		"		</object>"+
		"</div>";
		window[flag+"getMindPaints"] = function(){
			return paints;
		}
		window[flag+"Config"]=function(){
			return {
				background:typeof(userConfig.background)=="undefined"?true:userConfig.background,
				bordWidth:typeof(userConfig.bordWidth)=="undefined"?1:userConfig.bordWidth,
				bordColor:typeof(userConfig.bordColor)=="undefined"?0xdddddd:userConfig.bordColor,
				arrow:typeof(userConfig.arrow)=="undefined"?2:userConfig.arrow,
				getMindPaints:flag+"getMindPaints",
				onMindCreated:flag+"onMindCreated",
				onMindClick:flag+"onMindClick",
				onFullScreen:flag+"onFullScreen",
				editable:true
			}
		};
		window[flag+"onFullScreen"]=function(){
			var newPaints = window[flag+"mind"].getPaints();
			wrap.remove();
			callback(newPaints);
			return false;
		}
		window[flag+"onMindCreated"]=function(info){
			if((info.type=="Condition")||(info.type=="End")||(info.type=="Process")||(info.type=="Start")){
				var dialog = top.$.sysicon({jsp:$.contextPath()+'icons.jsp',callback:function(url){
					window[flag+"mind"].setPaintIcon(info.id,null);
					window[flag+"mind"].setPaintIcon(info.id,url);
				}});
				$("<button type='button' class='button'>移除图标</button>").appendTo(dialog.find(".option")).click(function(){
					window[flag+"mind"].setPaintIcon(info.id,null);
					top.$(this).closeDialog();
				});
			}
		};
		window[flag+"onMindClick"]=function(info){
			window[flag+"onMindCreated"](info);
		};
		wrap.html(mindTemplate);
		window[flag+"mind"] = (document.embeds[flag+"Mind"]||document[flag+"Mind"]||window[flag+"Mind"]);
	},
	sysicon:function(params){
		var html = $.ajax({
			  url: params.jsp,
			  cache: false,
			  async: false	  	
		 }).responseText;
		 var iconDialog=$(html).dialog({
				title:"系统图标",
				width:800,
				modal:true,
				flag:"sysIconDialog"
		 });
		 iconDialog.pngFix();
		 iconDialog.find("img.icon").click(function(){
		 	params.callback($(this).attr("src"));
		 	iconDialog.closeDialog();
		 });
		 return iconDialog;
	},
	/**
	* 显示一个time的提示框
	**/
	tips:function(content,time,callback){
		if(!document.body){
			return alert(content);
		}
		if(typeof(time)=="function"){
			callback=time;
			time = null;
		}
		var div=$("<div class='tips'><div class='content'></div></div>");
		div.find(".content").html(content);
		div.appendTo("body");
		div.css("left",(($(window).width())/2-(parseInt(div.width())/2)+$(document).scrollLeft())+"px");	
		div.css("top",(($(window).height())/2-(parseInt(div.height())/2)+$(document).scrollTop())+"px");
		div.show();
		setTimeout(function(){
			if(!div.mousein)
			{
				div.find(".content").fadeOut(1000,function(){
					div.remove();
					$.remove(div);
					if(callback)
						callback();
				});	
			}	
			div.mouseout(function(){
				div.stop();
				div.find(".content").fadeOut(1000,function(){
					div.remove();
					$.remove(div);
					if(callback)
						callback();
				});
			});
		},time?time:1000);
		div.mouseout(function(){
			div.mousein=false;
		});
		div.mouseover(function(){
			div.mousein=true;
			div.stop();
			div.fadeTo("fast",1);
		});
	},
	toast:function(content,time,callback){
		return $.tips(content,time,callback);
	},
	alert:function(message,callback){
		if($.trim(message)!=""){
			$.dialog({
				title:"消息提示",
				html:message,
				modal:true,
				static:true,
				onOk:callback
			});
		}
	},
	/**
	* 取最大的zIndex
	**/
	zindex:function(){
		if(!window.zindex)
			window.zindex=0xaaaa;
		return window.zindex++;		
	},	
	/**
	* 弹出对话框
	**/
	dialog:function(params)
	{
		if(!params)
			return;
		var div=$("<div></div>");
		div.html(params.html||$.ajax({url: params.url,cache: false,async: false}).responseText);
		return div.dialog(params);
	},
	/**
	* 弹出显示层
	**/
	paper:function(params)
	{
		if(!params)
			return;
		var paper=$("<table width='700' class='paper' border='1' cellspacing='0' cellpadding='0'><tr><td class='caption'><button class='button'></button></td></tr><tr><td class='body'><div class='content'></div></td></tr><tr><td class='option'><div class='line'></div></td></tr></table>");
		paper.find(".caption").html(params.title||"");		
		paper.find(".content").html(params.html||$.ajax({url: params.url,cache: false,async: false}).responseText);
		
		paper.close=function(){
			paper.overlay.find("iframe").remove();
			paper.overlay.remove();
			paper.find("iframe").remove();
			paper.remove();		
			$.remove(paper.overlay);	
			$.remove(paper);	
		}
		
		var closeBtn=$("<span class='close'>x</span>");
		closeBtn.prependTo(paper.find(".caption"));
		closeBtn.click(paper.close);
		
		var cancelBtn=$("<button class='button' type='button'>取消</button>");		
		cancelBtn.appendTo(paper.find(".option"));		
		cancelBtn.click(function(){
			paper.close();			
		});
		
		/*遮罩层*/
		paper.overlay=$("<div class='overlay'></div>");	
		paper.overlay.css("height",$(document).height()+20);
		paper.overlay.fadeTo("fast",0.3);
		paper.overlay.css("z-index",$.zindex());
		paper.overlay.appendTo("body");		
		paper.overlay.iframe=$("<iframe border='0' width='100%' height='100%'></iframe>");
		paper.overlay.iframe.appendTo(paper.overlay);
		paper.overlay.iframe.fadeTo("fast",0);
		
		paper.css("z-index",$.zindex());
		paper.appendTo("body");
		
		if(params.width)
			paper.find(".content").css("width",params.width);

		if( ($(window).width()-paper.width()-80) < 0)
			paper.find(".content").css("width",$(window).width()-80);

		paper.css("left",$(window).width()<paper.width()?0:($(window).width()-paper.width())/2);
		paper.css("top",$(window).height()<paper.height()?20:($(window).height()-paper.height())/2);
		
		//设置遮罩层高度
		paper.overlay.css("height",$(document).height()+20);
		
	},
	open:function(url,params,srcWin,callback){
		return $.showModalDialog(typeof(url)=="string"?{url:url}:url,params,srcWin,callback);
	},
	//关闭模拟系统模态对话框
	closeModalDialog:function(submited){
		var modalDialog = parent.$("#"+window.name).parents(".dialog");
		if(modalDialog.size()>0 && modalDialog.data("close"))
			modalDialog.data("close")(submited);
	},
	//模拟系统模态对话框
	showModalDialog:function(params,data,caller,callback){		
		if(!params)
			return;
		if(data && data==data.window){
			caller=data;
			data=null;
		}
		if(typeof(data)=="function"){
			callback = data;
			caller = null;
			data = null;
		}
		if(typeof(caller)=="function"){
			callback = caller;
			caller = null;
		}
		var indexOf = params.url.indexOf("?");
		var dialogFlag=(params.url.substring(0,indexOf>-1?indexOf:params.url.length));
		if($(".dialog[url='"+dialogFlag+"']").size()>0)
			$(".dialog[url='"+dialogFlag+"']").data("close")();
		
		var dialog=$("<table url='"+dialogFlag+"' class='dialog' border='0' cellspacing='0' cellpadding='0'><tr><td class='backdrop'><div class='mask'></div><table class='shadow' border='0' cellspacing='0' cellpadding='0'><tr>  <td class='tl'></td>  <td class='t'></td>  <td class='tr'></td></tr><tr>  <td class='l'></td>  <td class='c'><table class='state-content contentTalbe' border='0' cellspacing='0' cellpadding='0'><tr><td class='caption state-focus'><span class='title'></span></td></tr><tr><td class='body' style='border-width:0 1px 1px 1px;'></td></tr></table></td>  <td class='r'></td></tr><tr>  <td class='bl'></td>  <td class='b'></td>  <td class='br'></td></tr></table></td></tr></table>");
		dialog.find(".caption .title").html(params.title||"对话框");
		dialog.find(".caption").drag(dialog);
				
		
		var frameHandle = "handle_"+$.UUID();
		if(callback && data){
			var completeFunc = "complete_"+frameHandle;
			data.complete = "top."+completeFunc;
			top[completeFunc]=function(object){
				try{
					callback(object);
				}catch(e){
					alert(e.message);
				}
				dialog.data("close")();
			}
		}
		var contentframe = $("<iframe class='state-content' allowTransparency='true' id='"+frameHandle+"' name='"+frameHandle+"' src='' frameborder='0'></iframe>");
		
		
		/*******************暂时以大对话框*******************/
		if(!params.width)
			contentframe.attr("width",885);//885
		else
			contentframe.attr("width",params.width);
		if(!params.height)
			contentframe.attr("height",400);
		else
			contentframe.attr("height",params.height);
		/*******************暂时以大对话框*******************/
								
		contentframe.load(function(){
			frame = $(this).get(0);	
			if($(frame.contentWindow.document).size() && !params.width && !params.height){
				var framedocument = $(contentframe.get(0).contentWindow.document);
				dialog.find(".caption .title").html(framedocument.find("title").html());
				try{
					framedocument.find("textarea:first").select();		
					framedocument.find("input[type='text']:first").select();
				}catch(e){
					if(window["console"])
						window["console"].log(e.message);
				}
			}
			if(callback)
				callback();
			if(dialog.data("onSize")){
				dialog.data("onSize")(true);
			}
			frame.contentWindow.caller = caller?caller:frame.contentWindow;	
			if(frame.contentWindow.$fire){
				frame.contentWindow.$fire("caller");//通知子窗口，勾子窗口已设置
			}
		});
		contentframe.appendTo(dialog.find(".body"));
					
		dialog.data("close",dialog.close=function(submited){
			if(callback)
				callback(submited);
			if(dialog.data("overlay")){
				dialog.data("overlay").find("iframe").remove();
				dialog.data("overlay").remove();
			}
			dialog.find("iframe").remove();
			dialog.remove();
			$.remove(dialog.find("iframe"));
			$.remove(dialog.data("overlay"));	
			$.remove(dialog);
			return false;
		});
		
		var closeBtn=$("<span class='icon'>x</span>");
		closeBtn.prependTo(dialog.find(".caption"));
		closeBtn.click(function(){
			dialog.data("close")();
		});
				
		/*遮罩层*/
		var overlay=$("<div class='overlay'></div>");
		dialog.data("overlay",overlay);	
		overlay.css("height",$(document).height());
		overlay.css("z-index",$.zindex());
		if($.browser.msie){
			overlay.css("position","absolute");
			overlay.height($(caller.document).height());
			overlay.appendTo((caller&&caller.$)?caller.$("body"):$("body"));
		}else{
			overlay.appendTo((caller&&caller.$)?caller.$("body"):$("body"));
		}
			
		dialog.css("z-index",$.zindex());
		if(!$.browser.msie){
			dialog.css("opacity",0);
			contentframe.css("opacity",0);
		}
		$.loading(true).click(function(){
			$.loading(false);
		});
		dialog.appendTo("body");	
				
		//使用原调用页面post地址到iframe中，以保证服务器的referer地址不变
		(caller?caller:window).$.submit(params.url+(params.url.indexOf("?")>-1?"&":"?")+"mm="+Math.random(),data,frameHandle);
			
		dialog.data("onSize",function(runtime){
			var offset1={};
			if(runtime){
				//修改尺寸之前先隐藏
				if(!$.browser.msie)
					dialog.css("opacity",0);
				$.loading(false);
				offset1={left:dialog.offset().left,top:dialog.offset().top,width:contentframe.width(),height:contentframe.height()}
				/*if(!params.width && !params.height){
					contentframe.attr("width",100);
					contentframe.attr("height",100);
					var framedocument = $(contentframe.get(0).contentWindow.document);					
					contentframe.attr("width",framedocument.width()+25);
					contentframe.attr("height",framedocument.height());
				}*/
				if(!params.width)
					contentframe.attr("width",100);
				if(!params.height)
					contentframe.attr("height",100);
				var framedocument = $(contentframe.get(0).contentWindow.document);	
				if(!params.width)				
					contentframe.attr("width",framedocument.width()+25);
				if(!params.height)
					contentframe.attr("height",framedocument.height());
			}			

			if(($(window).width()-dialog.width()-80) < 0)
				contentframe.attr("width",$(window).width()-80);
			if(($(window).height()-dialog.height()-80) < 0)
				contentframe.attr("height",$(window).height()-80);
					
			var left = $(window).width()/2-parseInt(dialog.width())/2;
			if(left<10)
				left=10;
			var top = $(window).height()/2-parseInt(dialog.height())/2;
			if(top<10)
				top=10;
			top+=$(window).scrollTop();
			dialog.css("left",left+"px");	
			dialog.css("top",top+"px");	
			if(runtime){
				if(!$.browser.msie)
					dialog.css("opacity",1);//显示出来
				//完成时把尺寸设回去，再以动画效果变化到目标状态  
				var offset2={left:dialog.offset().left,top:dialog.offset().top,width:contentframe.width(),height:contentframe.height()}		
				dialog.css("left",offset1.left+"px");	
				dialog.css("top",offset1.top+"px");
				contentframe.attr("width",offset1.width);
				contentframe.attr("height",offset1.height);
				
				dialog.animate({
					left:offset2.left,top:offset2.top
				},$.browser.msie?1000:500,$.browser.msie?"easeOutBounce":"easeOutBounce");
				contentframe.animate({
					width:offset2.width,height:offset2.height
				},$.browser.msie?800:500,$.browser.msie?"easeOutBounce":"easeOutBounce",function(){
					if(!$.browser.msie)
						contentframe.css("opacity",1);
					contentframe.css("width","");
					contentframe.css("height","");	
					contentframe.attr("width",offset2.width);
					contentframe.attr("height",offset2.height);				
				});
				
			}
		});
		dialog.data("onSize")();
		
		
		//当调用窗口销毁时，当前对话框关闭
		$(caller).unload(function(){
			if(!dialog)
				return false;
			if(dialog.data("close"))
				dialog.data("close")();
		});
		
		//调用窗口可视化切换时
		top.$(caller).bind("visible",function(event,bVisible){
			if(!dialog)
				return false;
			if(bVisible)
				dialog.show();
			else
				dialog.hide();
			try{
				top.$(contentframe.get(0).contentWindow).trigger("visible",bVisible);
			}catch(e){}
		});	
				
		dialog.css("z-index",$.zindex());	
		
		dialog.css("opacity",1);
		overlay.fadeTo(1000,0.05);
						
		return dialog;
	},
	//模拟系统桌面窗口对话框
	showWindowDialog:function(params){
		var url=params.url;
		var frameHandle = params.flag;
		var indexOf = url.indexOf("?");
		var dialogFlag=(url.substring(0,indexOf>-1?indexOf:url.length));
		if($(".dialog[url='"+dialogFlag+"']").size()>0)
			$(".dialog[url='"+dialogFlag+"']").data("close")();
		//var dialog=$("<table url='"+dialogFlag+"' class='window dialog' border='0' cellspacing='0' cellpadding='0'><tr><td class='c'><table class='contentTalbe' border='0' cellspacing='0' cellpadding='0'><tr><td class='caption'><span class='title'></span></td></tr><tr><td class='body' style='border-width:0 1px 1px 1px;'></td></tr></table><div class='mask'></div></td></tr></table>");
		var dialog=$("<table url='"+dialogFlag+"' class='window dialog' border='0' cellspacing='0' cellpadding='0'><tr><td class='backdrop'><div class='mask'></div><table class='shadow' border='0' cellspacing='0' cellpadding='0'><tr>  <td class='tl'></td>  <td class='t'></td>  <td class='tr'></td></tr><tr>  <td class='l'></td>  <td class='c'><table class='contentTalbe' border='0' cellspacing='0' cellpadding='0'><tr><td class='caption'><span class='title'></span></td></tr><tr><td class='body' style='border-width:0 1px 1px 1px;'></td></tr></table><div class='titlemask'></div></td>  <td class='r'></td></tr><tr>  <td class='bl'></td>  <td class='b'></td>  <td class='br'></td></tr></table></td></tr></table>");
		dialog.find(".caption .title").html("桌面窗口");
		dialog.find(".caption").drag(dialog);
		var onloadFunc = "onload_"+$.UUID();
		var contentframe = $("<iframe class='state-content' allowTransparency='true' id='"+frameHandle+"' name='"+frameHandle+"' src='' frameborder='0'></iframe>");
		/*******************暂时以大对话框*******************/
		contentframe.attr("width",params.width||($(window).width()-200));
		contentframe.attr("height",params.height||($(window).height()-100));
		/*******************暂时以大对话框*******************/								
		contentframe.one("load",function(){
			frame = $(this).get(0);			
			if($(frame.contentWindow.document).size()){
				var framedocument = $(contentframe.get(0).contentWindow.document);
				dialog.find(".caption .title").html(framedocument.find("title").html());
				framedocument.find("textarea:first").select();				
				framedocument.find("input[type='text']:first").select();
				dialog.data("onSize")(true);
			}			
		});
		contentframe.appendTo(dialog.find(".body"));
		contentframe.attr("src",url);
					
		dialog.data("close",dialog.close=function(byOnCloser){
			dialog.find("iframe").remove();
			dialog.remove();
			$.remove(dialog);
			if(params.onClose && !byOnCloser)
				params.onClose();
			return false;	
		});
		
		var minBtn = $("<a href='javascript:void(0);' class='minimize imize'></a>");
		minBtn.prependTo(dialog.find(".caption"));
		minBtn.click(function(){
			dialog.hide();
			if(params.onMinimize)
				params.onMinimize();
			return false;
		});
				
		var maxBtn = $("<a href='javascript:void(0);' class='maximize imize'></a>");
		maxBtn.prependTo(dialog.find(".caption"));
		var toggleMize = function(){//切换最大化还原函数实现
			maxBtn.toggleClass("mutimize","maximize");
			if(maxBtn.hasClass("mutimize")){
				//保存当前的position
				dialog.data("position",{
					width:contentframe.width(),
					height:contentframe.height(),
					left:dialog.offset().left,
					top:dialog.offset().top
				});
				contentframe.attr("width",$(window).width()-10);
				contentframe.attr("height",$(window).height()-90);
				dialog.data("onSize")();
			}else{
				var position = dialog.data("position");
				contentframe.attr("width",position.width);
				contentframe.attr("height",position.height);
				dialog.css("left",position.left+"px");	
				dialog.css("top",position.top+"px");
			}
			if(params.onMaximize)
				params.onMaximize();
			return false;
		};
		maxBtn.click(toggleMize);//切换最大化还原
		dialog.find(".caption").dblclick(toggleMize);//双击切换最大化还原
		
		
		var closeBtn=$("<span class='icon'>x</span>");
		closeBtn.prependTo(dialog.find(".caption"));
		closeBtn.click(function(){
			dialog.data("close")();			
			return false;
		});
					
		dialog.css("z-index",$.zindex());
		dialog.css("opacity",0);
		dialog.appendTo("body");
		
		dialog.data("onSize",function(runtime){
			var offset1={};
			//当frame加载完成时，先把其尺寸设置为300*300以测试内容页是不是响应式布局
			if(runtime){
				//修改尺寸之前先隐藏
				dialog.css("opacity",0);
				offset1={left:dialog.offset().left,top:dialog.offset().top,width:contentframe.width(),height:contentframe.height()}			
				var framedocument = $(contentframe.get(0).contentWindow.document);
				var frameWidth = contentframe.width();
				var frameHeight = contentframe.height();
				if(framedocument.find(".table").size()==0){//.table页面不自适应宽度
					contentframe.attr("width",300);
					contentframe.attr("height",300);
				}
				if(framedocument.width()>400 && framedocument.find(".table").size()==0){//非响应式布局
					//.table页面不自适应宽度
					contentframe.attr("width",framedocument.width()+25);
					contentframe.attr("height",framedocument.height());
				}else{//响应式布局
					contentframe.attr("width",frameWidth);
					contentframe.attr("height",frameHeight);
				}
			}
			var $window = $(window);
			if(($window.width()-dialog.width()-10) < 0)
				contentframe.attr("width",$window.width()-10);
			if(($window.height()-dialog.height()-100) < 0)
				contentframe.attr("height",$window.height()-90);
			var left = $window.width()/2-parseInt(dialog.width())/2;//居中模式
			//var left = $window.width()-parseInt(dialog.width())-5;//居右模式
			var top = ($window.height()-40)/2-parseInt(dialog.height())/2;
			dialog.css("left",left+"px");
			dialog.css("top",top+"px");
			if(runtime){
				dialog.css("opacity",1);//显示出来
				//完成时把尺寸设回去，再以动画效果变化到目标状态
				var offset2={left:dialog.offset().left,top:dialog.offset().top,width:contentframe.width(),height:contentframe.height()}		
				dialog.css("left",offset1.left+"px");	
				dialog.css("top",offset1.top+"px");
				contentframe.attr("width",offset1.width);
				contentframe.attr("height",offset1.height);
				dialog.animate({
					left:offset2.left,top:offset2.top
				},$.browser.msie?800:500,$.browser.msie?"easeOutBounce":"easeOutBounce");
				contentframe.animate({
					width:offset2.width,height:offset2.height
				},$.browser.msie?800:500,$.browser.msie?"easeOutBounce":"easeOutBounce");
			}
		});
		dialog.data("onSize")();
		$(window).resize(function(){
			dialog.data("onSize")();
		});
		
		dialog.css("opacity",1);
										
		return dialog;
	},	
	//关闭消息对话框
	closeMsgDialog:function(){
		parent.$("#"+window.name).parents(".dialog").data("close")();
	},
	//显示一个消息对话框
	showMsgDialog:function(params){
		if(!params)
			return;
		//if(window!=window.top)
			//return window.top.$.showMsgDialog(params);	
		
		var id = "message-dialog";
		if(params.flag)
			id = params.flag;
				
		if($("#"+id).size()>0)
			return;	
				
		//var dialog=$("<table id='"+id+"' class='shadow dialog msgDialog' border='0' cellspacing='0' cellpadding='0'><tr>  <td class='tl'></td>  <td class='t'></td>  <td class='tr'></td></tr><tr>  <td class='l'></td>  <td class='c'><table class='state-content contentTalbe' border='0' cellspacing='0' cellpadding='0'><tr><td class='caption state-focus'><button class='button'></button></td></tr><tr><td class='body'><div class='content'></div></td></tr><tr><td class='option'><div class='line'></div></td></tr></table></td>  <td class='r'></td></tr><tr>  <td class='bl'></td>  <td class='b'></td>  <td class='br'></td></tr></table>");		
		var dialog=$("<table id='"+id+"' class='shadow dialog msgDialog' border='0' cellspacing='0' cellpadding='0'><tr><td class='c'><table class='state-content contentTalbe' width='363' border='0' cellspacing='0' cellpadding='0'><tr><td class='caption state-focus'><span class='title'></span></td></tr><tr><td class='body' style='border-width:0 1px 1px 1px;'></td></tr></table></td></tr></table>");		
		dialog.find(".caption .title").html(params.title||"消息对话框");
		dialog.find(".caption").css("cursor","pointer");
		dialog.find(".caption").drag(dialog);
				
		//如果设置时间,自动控制关闭效果
		if(params.time){
			dialog.mouseout(function(){
				dialog.mousein=false;
			});
			dialog.mouseover(function(){
				dialog.mousein=true;
				dialog.stop();
				dialog.fadeTo("fast",1);
			});
			var autoClose=function(){				
				if(!dialog.mousein)
				{
					dialog.fadeOut(1000,function(){
						dialog.data("close")();
					});	
				}
				dialog.mouseout(function(){
					dialog.stop();
					dialog.fadeOut(1000,function(){
						dialog.data("close")();
					});
				});
			}
			dialog.data("autoClose",autoClose);
			setTimeout(autoClose,params.time);
		}
		
				
		if(params.url){
			var frameHandle = "handle_"+$.UUID();
			var contentframe = $("<iframe width=360 height=220 id='"+frameHandle+"' name='"+frameHandle+"' src='#' frameborder='0'></iframe>");
			contentframe.appendTo(dialog.find(".body"));
			contentframe.load(function(){
				//如果设置时间,自动控制关闭效果
				if(params.time){
					setTimeout(dialog.data("autoClose"),params.time);
				}
			});
			contentframe.attr("src",params.url);
		}else if(params.content){
			params.content.appendTo(dialog.find(".body"));
		}else if(params.html){
			dialog.find(".body").html("<div style='padding:20px;'>"+params.html+"</div>");
		}
		
		
		if(!params.notmin){
			var toggleBtn=$("<span class='icon'>↓</span>");
			toggleBtn.prependTo(dialog.find(".caption"));
			toggleBtn.toggle(function(){
				$(this).html("↑");
				dialog.find(".body").hide();
				//var top = $(window).height()-parseInt(dialog.find(".caption").height()+6);
				//dialog.css("top",top+"px");
			},function(){
				$(this).html("↓");
				dialog.find(".body").show();
				//var top = $(window).height()-parseInt(dialog.height());
				//dialog.css("top",top+"px");
			});
		}
		
					
		dialog.data("close",dialog.close = function(){
			if(dialog.data("overlay")){
				dialog.data("overlay").find("iframe").remove();
				dialog.data("overlay").remove();
			}
			dialog.find("iframe").remove();
			dialog.remove();
			$.remove(dialog.data("overlay"));	
			$.remove(dialog);
		});
		
		var closeBtn=$("<span class='icon'>x</span>");
		closeBtn.prependTo(dialog.find(".caption"));
		closeBtn.click(function(){
			dialog.data("close")();
			return false;
		});
		
				
		/*遮罩层*/
		var overlay=$("<div class='overlay'></div>");
		dialog.data("overlay",overlay);	
		overlay.css("width",dialog.width());
		overlay.css("height",dialog.height());
		overlay.css("z-index",$.zindex());
		overlay.appendTo("body");
		var iframe=$("<iframe border='0' width='100%' height='100%'></iframe>");
		iframe.appendTo(overlay);
		
		
		var dialogs = $(".msgDialog");
		var minTop =  $(window).height();
		var relateDialog = null;
		var bottom =  3;
		dialogs.each(function(){
			if($(this).offset().top < minTop){
				minTop = $(this).offset().top;
				bottom += $(this).height()+3;
				relateDialog = $(this);
			}
		});	
		
					
		dialog.css("z-index",$.zindex());
		dialog.appendTo("body");


		//位置固定在右下角
		var left = $(window).width()-parseInt(dialog.width());
		if(relateDialog)
			left = relateDialog.offset().left;
		var top = minTop-parseInt(dialog.height()) - 2;
		dialog.css("left","auto");	
		dialog.css("top","auto");
		dialog.css("right","20px");	
		dialog.css("bottom",bottom+"px");
		dialog.css("position","fixed");
		overlay.css("left",left+"px");	
		overlay.css("top",top+"px");
		overlay.css("position","fixed");		
		
		dialog.css("z-index",$.zindex());
		dialog.css("box-shadow","0px 0px 10px #333333");
						
		return dialog;
	},
	empty:function(str){
		return $.trim(str)=="";
	},
	/*
	* 显示图片略缩图
	*/
	thumb:function(params){
		window.open(params.url);
	},
	/*设置大小*/
	resize:function(func){
		$(window).resize(func);
		$(document).resize(func);
		func();
	},
	/**
	获取当前日期时间星期
	格式
	YYYY/yyyy/YY/yy 表示年份   
	MM/M 月份   
	W/w 星期   
	dd/DD/d/D 日期   
	hh/HH/h/H 时间   
	mm/m 分钟   
	ss/SS/s/S 秒
	**/
    formatDate: function(strFormat,date) {
		var dDate=date?date:new Date();
		var str = strFormat;    
		var Week = ['日','一','二','三','四','五','六'];   
	   
		str=str.replace(/yyyy|YYYY/,dDate.getFullYear());    
		str=str.replace(/yy|YY/,(dDate.getYear() % 100)>9?(dDate.getYear() % 100).toString():'0' + (dDate.getYear() % 100));    
	   
		str=str.replace(/MM/,dDate.getMonth()>8?(dDate.getMonth()+1):'0' + (dDate.getMonth()+1));    
		str=str.replace(/M/g,dDate.getMonth()+1);    
	   
		str=str.replace(/w|W/g,Week[dDate.getDay()]);    
	   
		str=str.replace(/dd|DD/,dDate.getDate()>9?dDate.getDate().toString():'0' + dDate.getDate());    
		str=str.replace(/d|D/g,dDate.getDate());    
	   
		str=str.replace(/hh|HH/,dDate.getHours()>9?dDate.getHours().toString():'0' + dDate.getHours());    
		str=str.replace(/h|H/g,dDate.getHours());    
		str=str.replace(/mm/,dDate.getMinutes()>9?dDate.getMinutes().toString():'0' + dDate.getMinutes());    
		str=str.replace(/m/g,dDate.getMinutes());    
	   
		str=str.replace(/ss|SS/,dDate.getSeconds()>9?dDate.getSeconds().toString():'0' + dDate.getSeconds());    
		str=str.replace(/s|S/g,dDate.getSeconds());    
	   
		return str;
	},
	dateFormat:function(string,format){//将字符串转换成日期时间，有默认格式
		if(format == null) format = 'yyyy-MM-dd hh:mm:ss';
		var compare = {'y+' : 'y','M+' : 'M','d+' : 'd','H+' : 'H','m+' : 'm','s+' : 's'};
		var result = {'y' : '','M' : '','d' : '','H' : '00','m' : '00','s' : '00'};
		var tmp = format;
		for (var k in compare) {		
			if (new RegExp('(' + k + ')').test(format))
				 result[compare[k]] = string.substring(tmp.indexOf(RegExp.$1), tmp.indexOf(RegExp.$1) +RegExp.$1.length);
		}
		return new Date(result['y'], result['M'] - 1, result['d'], result['H'], result['m'], result['s']);
	},
	date:function(date,format){
		if(typeof(date)=="string")
			return $.dateFormat(date,format||"yyyy-MM-dd HH:mm:dd");
		else
			return $.formatDate(format||"yyyy-MM-dd HH:mm:dd",date);
	},
	sizeFormat:function(number){
		if(!number || number<0)
			number=0;
		number=number/1024/1024;		
		number=""+number;
		var reg=/^(([1-9]\d{0,9})|0)(\.)?(\d{1,2})?/;
		return (number.match(reg)?number.match(reg)[0]:'')+"M";
	},
	cookie:function(name, value, options) {
		if (typeof value != 'undefined') { // name and value given, set cookie
			options = options || {};
			if (value === null) {
				value = '';
				options.expires = -1;
			}
			var expires = '';
			if (options.expires && (typeof options.expires == 'number' || options.expires.toGMTString)) {//toUTCString
				var date;
				if (typeof options.expires == 'number') {
					date = new Date();
					date.setTime(date.getTime() + (options.expires * 24 * 60 * 60 * 1000));
				} else {
					date = options.expires;
				}
				expires = '; expires=' + date.toGMTString();//toUTCString // use expires attribute, max-age is not supported by IE
			}
			var path = options.path ? '; path=' + options.path : '';
			var domain = options.domain ? '; domain=' + options.domain : '';
			var secure = options.secure ? '; secure' : '';
			document.cookie = [name, '=', encodeURIComponent(value), expires, path, domain, secure].join('');
		} else { // only name given, get cookie
			var cookieValue = null;
			if (document.cookie && document.cookie != '') {
				var cookies = document.cookie.split(';');
				for (var i = 0; i < cookies.length; i++) {
					var cookie = jQuery.trim(cookies[i]);
					// Does this cookie string begin with the name we want?
					if (cookie.substring(0, name.length + 1) == (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}
	}
	,UUID:function(){
		var S4=function () {
       		 return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
	    };
	    return (S4()+S4()+S4()+S4()+S4()+S4()+S4()+S4());
	}
	,hashCode:function(str){
		var hash = 0;
	    if (str.length == 0) return hash;
	    for (i = 0; i < str.length; i++) {
	        char = str.charCodeAt(i);
	        hash = ((hash<<5)-hash)+char;
	        hash = hash & hash; // Convert to 32bit integer
	    }
	    return hash;
	}
	,locationFlag:function(){
		var url = window.location.href;
		if(url.indexOf("?")>-1)
			url = url.substring(0,url.indexOf("?"));
		return window.hashcode || $("meta[name='hashcode']").attr("content") || new String($.hashCode(url)).replace("-","");
	}
	//页面级数据缓存,keys字符串，多个key以小.连接
	,cache:function(keys,value){
		var strCookie = $.cookie($.locationFlag());
		if($.trim(strCookie)=="")
			strCookie="{}";
		var pageObject = eval("("+strCookie+")");
		var array = keys.split(".");
		var nodeObject = pageObject;
		for(var i=0;i<array.length-1;i++){
			var key = array[i];
			if(!nodeObject[key])
				nodeObject[key]=new Object();
			nodeObject=nodeObject[key];
		}
		if(arguments.length==1)
			return nodeObject[array[array.length-1]];
		if(value==null)
			delete nodeObject[array[array.length-1]];
		else
			nodeObject[array[array.length-1]]=value;
		$.cookie($.locationFlag(),JSON.stringify(pageObject),{expires:365});
	}
	,remove:function(object){
		$.event.remove(object);
		$.removeData(object);
		object.html("");
		object = null;
		delete object;
	}
	,basePath:function(){
		var src = $("script[src*='js/lazy3q.ui.js']").attr("src")||"/";
		return (src.substr(0,src.indexOf('js/lazy3q.ui.js')));
	}
	,contextPath:function(){
		return top.contextPath||top.$("meta[name='contextPath']").attr("content");
	}
});

jQuery.easing['jswing'] = jQuery.easing['swing'];

jQuery.extend( jQuery.easing,
{
	def: 'easeOutQuad',
	swing: function (x, t, b, c, d) {
		//alert(jQuery.easing.default);
		return jQuery.easing[jQuery.easing.def](x, t, b, c, d);
	},
	easeInQuad: function (x, t, b, c, d) {
		return c*(t/=d)*t + b;
	},
	easeOutQuad: function (x, t, b, c, d) {
		return -c *(t/=d)*(t-2) + b;
	},
	easeInOutQuad: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t + b;
		return -c/2 * ((--t)*(t-2) - 1) + b;
	},
	easeInCubic: function (x, t, b, c, d) {
		return c*(t/=d)*t*t + b;
	},
	easeOutCubic: function (x, t, b, c, d) {
		return c*((t=t/d-1)*t*t + 1) + b;
	},
	easeInOutCubic: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t + b;
		return c/2*((t-=2)*t*t + 2) + b;
	},
	easeInQuart: function (x, t, b, c, d) {
		return c*(t/=d)*t*t*t + b;
	},
	easeOutQuart: function (x, t, b, c, d) {
		return -c * ((t=t/d-1)*t*t*t - 1) + b;
	},
	easeInOutQuart: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t*t + b;
		return -c/2 * ((t-=2)*t*t*t - 2) + b;
	},
	easeInQuint: function (x, t, b, c, d) {
		return c*(t/=d)*t*t*t*t + b;
	},
	easeOutQuint: function (x, t, b, c, d) {
		return c*((t=t/d-1)*t*t*t*t + 1) + b;
	},
	easeInOutQuint: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t*t*t + b;
		return c/2*((t-=2)*t*t*t*t + 2) + b;
	},
	easeInSine: function (x, t, b, c, d) {
		return -c * Math.cos(t/d * (Math.PI/2)) + c + b;
	},
	easeOutSine: function (x, t, b, c, d) {
		return c * Math.sin(t/d * (Math.PI/2)) + b;
	},
	easeInOutSine: function (x, t, b, c, d) {
		return -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;
	},
	easeInExpo: function (x, t, b, c, d) {
		return (t==0) ? b : c * Math.pow(2, 10 * (t/d - 1)) + b;
	},
	easeOutExpo: function (x, t, b, c, d) {
		return (t==d) ? b+c : c * (-Math.pow(2, -10 * t/d) + 1) + b;
	},
	easeInOutExpo: function (x, t, b, c, d) {
		if (t==0) return b;
		if (t==d) return b+c;
		if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b;
		return c/2 * (-Math.pow(2, -10 * --t) + 2) + b;
	},
	easeInCirc: function (x, t, b, c, d) {
		return -c * (Math.sqrt(1 - (t/=d)*t) - 1) + b;
	},
	easeOutCirc: function (x, t, b, c, d) {
		return c * Math.sqrt(1 - (t=t/d-1)*t) + b;
	},
	easeInOutCirc: function (x, t, b, c, d) {
		if ((t/=d/2) < 1) return -c/2 * (Math.sqrt(1 - t*t) - 1) + b;
		return c/2 * (Math.sqrt(1 - (t-=2)*t) + 1) + b;
	},
	easeInElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		return -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
	},
	easeOutElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		return a*Math.pow(2,-10*t) * Math.sin( (t*d-s)*(2*Math.PI)/p ) + c + b;
	},
	easeInOutElastic: function (x, t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3*1.5);
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		if (t < 1) return -.5*(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
		return a*Math.pow(2,-10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )*.5 + c + b;
	},
	easeInBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		return c*(t/=d)*t*((s+1)*t - s) + b;
	},
	easeOutBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b;
	},
	easeInOutBack: function (x, t, b, c, d, s) {
		if (s == undefined) s = 1.70158; 
		if ((t/=d/2) < 1) return c/2*(t*t*(((s*=(1.525))+1)*t - s)) + b;
		return c/2*((t-=2)*t*(((s*=(1.525))+1)*t + s) + 2) + b;
	},
	easeInBounce: function (x, t, b, c, d) {
		return c - jQuery.easing.easeOutBounce (x, d-t, 0, c, d) + b;
	},
	easeOutBounce: function (x, t, b, c, d) {
		if ((t/=d) < (1/2.75)) {
			return c*(7.5625*t*t) + b;
		} else if (t < (2/2.75)) {
			return c*(7.5625*(t-=(1.5/2.75))*t + .75) + b;
		} else if (t < (2.5/2.75)) {
			return c*(7.5625*(t-=(2.25/2.75))*t + .9375) + b;
		} else {
			return c*(7.5625*(t-=(2.625/2.75))*t + .984375) + b;
		}
	},
	easeInOutBounce: function (x, t, b, c, d) {
		if (t < d/2) return jQuery.easing.easeInBounce (x, t*2, 0, c, d) * .5 + b;
		return jQuery.easing.easeOutBounce (x, t*2-d, 0, c, d) * .5 + c*.5 + b;
	}
});

//事件监听
window.$listenmap={};
window.$on=function($type,$func){
	var $listens = window.$listenmap[$type];
	if(!$listens)
		$listens = window.$listenmap[$type] = [];
	if($func){
		$listens[$listens.length]=$func;
	}
};
window.$fire=function($type,$param){
	var $listens = window.$listenmap[$type];
	if(!$listens)
		$listens = window.$listenmap[$type] = [];
	for(var o in $listens)
		$listens[o]($param);
};

//javascript:void(eval("alert("+"#77ffcc3f".replace(/([a-fA-F0-9]{2})/g,"+','+0x$1").replace("#+','+","")+")"));

/*设置默认的js*/
$(function(){
	
	if(window.init)return;
	window.init=true;
	
	window.$fire("readyStart");
	
	/***********************编辑页显示全部、部分切换***************************/
	var toggleAll = function(noSize){
		if($(this).is(":checked")){
			$(".minor").show();			
		}else{
			$(".minor").hide();
		}
		try{
			parent.$("#"+window.name).parents(".dialog").data("onSize")(true);
		}catch(ex){}
	};
	if($("#all").size()>0){
		$("#all").attr("checked","checked");
		//($("#all").toggleAll = toggleAll)();
		//toggleAll(true);
	}
	$("#all").click(toggleAll);	
	$(".display").mouseenter(function(){
		$(this).find(">dd").show();
	});
	$(".display").mouseleave(function(){
		$(this).find(">dd").hide();
	});
	
	/***********************快捷查询的显示与隐藏***************************/
	$(".toggler").click(function(){
		if(!$(".shortcuts").is(":visible")){
			$(".shortcuts").show().next().addClass("margin-by-shortcut");
			$(this).find("span").addClass("on");
			$.cache("shortcuts","show");
		}else{
			$(".shortcuts").hide().next().removeClass("margin-by-shortcut");
			$(this).find("span").removeClass("on");
			$.cache("shortcuts","hide");
		}
	});
	if($.browser.msie){
		$(window).scroll(function(){
			$(".shortcuts").css("top",$(window).scrollTop()+"px");
		});
	}
	
		
	/***********************数据列表页显示控制***************************/
	$(".display dd a[all='']").click(function(){
		var lasteres = $("input[name='fields']").val();
		var selectes = "";
		var strAll = $("input[name='all']").val();
		if(strAll!="true"){//if($.trim(strFields)==""){// || strAll=="true"
			selectes="";
			$(".table .state-header td").each(function(){
				var ref = $(this).attr("ref")||$(this).attr("tdid");
				if($.trim(ref)!="")
					selectes+=(selectes==""?"":",")+ref;
			});
		}
		var className = $(this).parents(".display").attr("ref");
		var href = $(this).attr("href");
		$.getFields({
			className:className,
			title:"选择要显示的列",
			selected:selectes,
			lasteres:lasteres,
			depth:1,
			callback:function(fields){
				if(href.indexOf("http://")==-1){
					var winhref=window.location.href.substring(0,window.location.href.indexOf("?"));
					window.location.href=winhref+href+"&fields="+fields;
				}else{
					window.location.href=href+"&fields="+fields+"&setFields=true";
				}	
			}
		});
		return false;
	});
	
	/*******************tabs切换处理********************/
	$(".tabs").each(function(){
		var pThis = $(this);
		var focusClass = $(this).attr("focus");
		$(this).find("[ref]").click(function(){
			pThis.find("[ref]").each(function(){
				$($(this).attr("ref")).hide();
				$(this).removeClass(focusClass);				
			});
			$($(this).attr("ref")).show();
			$(this).addClass(focusClass);
		});
	});
	
	
	
	/**********************连接查询相关************************/
	$(".join").click(function(){
		top.$.open({
			url:$(this).attr("url"),
			title:"连接预查询",
			width:$(window).width()
		},{
			objects:$(this).val()
		},window);
		$(this).attr("checked",false);
		window.lastClickRadio = $(this);
	});	
	window.$on("caller",function(){		
		$(".oncancel").click(function(){
			var radio = window.caller.lastClickRadio;
			var dd = radio.parents("dd");
			radio.attr("checked",false);
			dd.find(".b").addClass("hidden");
			dd.find(".a").removeClass("hidden");
			$.closeModalDialog();
		});	
		//当连接查询时，点击确定时，先查询数据库，再返回		
		$(".onok").click(function(){
			window.caller.onJoinQueryComplete = window.name;//在父窗口中添加连接查询完成标识			
			$(this).parents("form").submit();
		});
		//当进入页面时发现父窗口的连接查询完成标识等于当前窗口的句柄，则返回结果给调用窗口
		if(window.caller && window.caller.onJoinQueryComplete == window.name){
			var radio = window.caller.lastClickRadio;
			var dd = radio.parents("dd");
			window.objects.on=radio.attr("ref");//指定关联哪个字段进行查询
			radio.val(JSON.stringify(window.objects));			
			radio.attr("checked",true);
			dd.find(".b").html("连接查询("+window.objects.count+")");
			dd.find(".a").addClass("hidden");
			dd.find(".b").removeClass("hidden");
			$.closeModalDialog();
		}
	});
	
	
	//关联对象的添加方法
	$(".reladd").click(function(){
		var config = eval("("+$(this).attr("config")+")");
		var completefunction = "complete_"+$.UUID();
		var dialog = null;
		top[completefunction]=function(object){
			try{
				config.callback(object);
			}catch(e){
				alert(e.message);
			}
			dialog.close();
		}
		dialog = top.$.showModalDialog({url:config.action},{complete:"top."+completefunction},window);		
	});
	
	try{
		if(window.opener && window.opener.location.href.indexOf("login.do")>-1){
			try{
				window.opener.location.href="login.do?opener=true";
				window.opener.blur();
				window.opener=null;
			}catch(e){}
			window.moveTo(0,0);
			window.resizeTo(screen.availWidth,screen.availHeight);
			window.focus();
		}
	}catch(e){}
	
	
	if($("#loginForm").size()>0){
		$(function(){
			window.validationEx=window.validation;
			window.validation=function(){
				var beforeValid = window.validationEx();
				if(beforeValid==true && window.opener==null && $("#fullscreen").is(":checked")){	
					var arg = "height="+(screen.availHeight)+",width="+screen.availWidth+",fullscreen=yes,top=0,toolbar=no,titlebar=no,menubar=no,scrollbars=no,resizable=yes,location=no,status=no";
					var windowid = "lazy3qwebframework";
					if(window.name!=windowid)			
						window.open("",windowid,arg);
					$("#loginForm").attr("target",windowid);
				}
				return beforeValid;
			};
		});	
	}
	
	//处理窗口滚动条数据，保存在窗口对象中,再次进入时滚动到之前的位置
	if(parent && parent.$){
		var parentFrame = parent.$("#"+window.name);
		if(parentFrame.size()>0){
			var scroll = parentFrame.data("scroll");
			if(scroll)
				window.scrollTo(scroll.left||0,scroll.top||0);		
		}
		$(window).unload(function(){
			parentFrame.data("scroll",{
				left:$(window).scrollLeft(),
				top:$(window).scrollTop()
			})
		});		
	}
	
	//点击最大化最小化，并且保存到cookie
	$(".imize").click(function(){
		if($(this).hasClass("minimize")){
			$(".plate").show();
			$(this).removeClass("minimize").addClass("maximize");
			$.cache("imize","maximize");
		}else if($(this).hasClass("maximize")){
			$(".plate").hide();
			$(this).removeClass("maximize").addClass("minimize");
			$.cache("imize","minimize");
		}
	});
	$(".setting").click(function(){
		var dialog = top.$("<button class='clear-cache button' style='margin:40px 100px;' type='button'>清除页面缓存</button>").dialog({
			title:"页面设置",
			modal:true,
			buttons:[]
		});
		dialog.find(".clear-cache").click(function(){//清除属于当前页面的cookie设置
			$.cookie($.locationFlag(),null);				
			dialog.close();
			showTips("页面缓存设置已清除!");
		});
	});
	
	$(".checkbox").mousedown(function(e){
		var check_class="";
		if($(this).hasClass("checked-yes"))
			check_class = "checked-yes";
		if($(this).hasClass("checked-not"))
			check_class = "checked-not";
		$(this).removeClass("checked-yes").removeClass("checked-not");
		if(e.which==1){
			if(check_class=="checked-not"){
				$(this).attr("title","不包含");
				$("#"+$(this).attr("for")).val("");
			}else{
				$(this).addClass("checked-not").attr("title","不包含");
				$("#"+$(this).attr("for")).val("not");
			}
		}else if(e.which==3){
			if(check_class=="checked-yes"){
				$(this).attr("title","不包含");
				$("#"+$(this).attr("for")).val("");
			}else{
				$(this).addClass("checked-yes").attr("title","等于");
				$("#"+$(this).attr("for")).val("yes");
			}
		}
		return false;
	}).each(function(){
		$(this).get(0).oncontextmenu=function(event){
			return false;
		}
	});
	
	$("input[type='text']").addClass("text");
	$(".table").tabler();
	$(".table .options").options();
	$(".query-flag").attr("addFlagText",function(){
		var p=$(this).parent();
		if(p.get(0) && p.get(0).tagName=="A" && $.trim(p.text())==""){
			p.html(p.html()+"[无]");
		}
	});
	$(".combox,.generic").combox();
	$("[mind]").each(function(){
		$(this).mind();
	});
	
	$(".grid[grid]").each(function(){
		var div = $("<div></div>").insertBefore($(this).hide()).width(620).css("float","left");
		var $this = $(this);
		var grid=div.grid({
			column:eval("("+$(this).attr("grid")+")"),
			change:function(input){
				$this.val(grid.getValue());
			}
		});
		if($.trim($(this).val())!="")
			grid.setValue(eval("("+$(this).val()+")"));
	});
	
	$("[type='date'],[type='datetime']").date();
	
	if(top.$("#anonymousiframe").size()==0)
		$("<iframe id=\"anonymousiframe\" name=\"anonymousiframe\" src=\"\" width=\"0\" height=\"0\" style=\"display:none;\"></iframe>").appendTo(top.$("body"));
	$(function(){
		$(".editform button[type='submit']").click(function(){
			if($(this).val()=="完成")
				$(".editform").attr('target',caller.name);
			else if($(this).val()=="保存")
				$(".editform").attr('target','_self');
			else if($(this).val()=="提交")
				$(".editform").attr('target','anonymousiframe');
			else if($(this).attr("target"))
				$(".editform").attr('target',$(this).attr("target"));
			else
				$(".editform").attr('target',caller.name);	
		});
		$(".editform").submit(function(event){
			if(""+event.result!="false" && $(".editform").attr('target')==caller.name){
				if(window.name==caller.name){
					caller = top.$("#anonymousiframe").get(0).contentWindow;
					$(".editform").attr('target','anonymousiframe');
				}
				$(caller).unload(function(){
					$.closeModalDialog(true);
				});
			}
			if(""+event.result!="false" && $(".editform").attr('target')=="anonymousiframe"){
				caller = top.$("#anonymousiframe").get(0).contentWindow;
				$(".editform").attr('target','anonymousiframe');
				$(caller).unload(function(){
					$.closeModalDialog(true);
				});
			}
			if(!typeof(event.result)=="undefined" && event.result==false)
				return false;
		});	
		$(".queryForm").submit(function(event){
			if(!typeof(event.result)=="undefined" && event.result==false)
				return false;
			$.loading(true);
		});				
		if($(".editform").size()){
			var frame = parent.$("#"+window.name).get(0);
			var entrypoint=$.trim($("#entrypoint").val());
			if(frame && frame.caller && frame.caller!=window.parent && entrypoint!=""){
				if(frame.loaded)
					frame.caller.location=decodeURIComponent(entrypoint.replace(/([\s\S]{2})/g,"%$1"));
				else
					frame.loaded=true;
			}
			if(frame && frame.caller)
				$(".editform").attr('target',frame.caller.name);
		}		
	});
	//如果查询页为宽屏，则修改查询按钮居中
	if($("form input[name=all]").val()=="true"){
		var table = $("form.query .option table");
		table.css("float","left");
		$(window).scroll(function(){			
			table.css("margin-left",$(window).scrollLeft()+($(window).width()-table.width())/2);
		}); 
		$(window).scroll();
	}
	//把编辑页的子页拼一个Tab切换风格
	var iframelist = $("iframe.iframe-list");
	if(iframelist.size()>1){
		$("body").wrapInner($("<div class='wrap-body'></div>"));
		var pager = $("body .wrap-body");
		var filler = $("<div class='fill-body'></div>").appendTo("body");
		var center = $("<div class='wrap-iframes'></div>").appendTo(filler);
		var iframes = $("<div class='tab-iframes'><div class='tits'><div class='opts'><a href='javascript:void(0);' class='L'></a><a href='javascript:void(0);' class='R'></a><a href='javascript:void(0);' class='C'>X</a></div><div class='btns'></div></div><div class='state-input click-tips'>请点击选项卡查看更多信息...</div><div class='cnts'></div></div>").appendTo(center);
		var tits = iframes.find(".tits");
		var cnts = iframes.find(".cnts");
		var opts = iframes.find(".opts");
		var btns = iframes.find(".btns");
		var table = $("<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\">").appendTo(btns);
		var tr = $("<tr></tr>").appendTo(table);
		opts.find(".C").click(function(){
			if($("body").hasClass("body-wrap")){
				if($.browser.msie){
					$("body").attr("scroll","");
				}
				var scrollLeft = pager.scrollLeft();
				var scrollTop = pager.scrollTop();
				$("body").removeClass("body-wrap");
				window.scrollTo(scrollLeft,scrollTop);
			}
		});
		var animatetime=0;
		opts.find(".L").mousedown(function(){
			btns.stop().animate({
					scrollLeft:btns.scrollLeft()-btns.find("button").width()
				},200);
			animatetime=setInterval(function(){
				btns.stop().animate({
					scrollLeft:btns.scrollLeft()-btns.find("button").width()
				},200);
			},100);
		}).mouseup(function(){
			clearInterval(animatetime);
		});
		opts.find(".R").mousedown(function(){
			btns.stop().animate({
					scrollLeft:btns.scrollLeft()+btns.find("button").width()
				},200);
			animatetime=setInterval(function(){
				btns.stop().animate({
					scrollLeft:btns.scrollLeft()+btns.find("button").width()
				},200);
			},100);
		}).mouseup(function(){
			clearInterval(animatetime);
		});
		if($.browser.msie){
			window.$body = $("body");
			window.$window = $(window);
			$(window).scroll(function(){
				if(!$body.hasClass("body-wrap")){
					var top = $window.scrollTop()+$window.height()-center.height();
					$body.css("top",top+"px");
				}
			});
		}
		iframelist.each(function(i,o){
			var dl = $(this).parents("dl");
			var iframe = dl.find("iframe").css("text-indent","0px").appendTo(iframes.find(".cnts"));
			var td = $("<td></td>").appendTo(tr);
			var button = $("<button style='float:left;' type='button' class='button'></button").appendTo(td);
			button.attr("ref",iframe.attr("id"));
			button.html(dl.find("dt").text().replace(/[:：]/g,""));
			button.click(function(){
				if(!$("body").hasClass("body-wrap")){
					var scrollLeft = $(window).scrollLeft();
					var scrollTop = $(window).scrollTop();
					$("body").addClass("body-wrap");
					pager.scrollLeft(scrollLeft);
					pager.scrollTop(scrollTop);
					if($.browser.msie){
						$("body").attr("scroll","no");
						center.css("top","auto");
					}
				}
				var visibleIframe = iframes.find("iframe:visible");
				visibleIframe.hide();
				if(visibleIframe.size()>0){
					top.$(visibleIframe.get(0).contentWindow).trigger("visible",false);
				}
				iframes.find(".on").removeClass("on");
				
				cnts.height(filler.height()-32);
				
				var frame = $("#"+$(this).attr("ref")).show();
				frame.attr("onload","return false;");
				frame.attr("height","100%");
				frame.css("height","100%");
				if(frame.attr("src")==""){
					if($.browser.msie){
						frame.load(function(){
							frame.attr("height","100%");
							frame.css("height","100%");
						});
					}
					frame.attr("src",frame.attr("url"));
				}
				top.$(frame.get(0).contentWindow).trigger("visible",true);
				$(this).addClass("on");
			});
			dl.remove();
		});
	}else if(iframelist.size()==1){
		iframelist.next().find(".button").trigger("click");
	}
	
	
	$(".query dl[group]").mouseenter(function(){
		$(".query dl[group='"+$(this).attr("group")+"']").addClass("conner");
	});
	$(".query dl[group]").mouseleave(function(){
		$(".query dl[group]").removeClass("conner");
	});
	
	/*************************处理初始进入时传入的参数************************/
	if($(".query").size()>0){
		var sAction = $(".query").attr("action");
		var array = sAction.split("?");
		if(array.length>1){
			var params = array[1].split("&");
			var strParams = "";
			for(var o in params){
				if($(".query").find("[name='"+params[o].split("=")[0]+"']").size()>0)
					continue;
				strParams+=params[o]+"&";
			}
			$(".query").attr("action",array[0]+"?"+strParams);
		}
	}
	
});


function showTips(msg){
	if($.trim(msg)!=""){
		top.$.dialog({
			title:"消息提示",
			html:msg,
			modal:true,
			static:true
		});
	}
}
function Alert(msg,callback){
	if($.trim(msg)!=""){
		$.dialog({
			title:"消息提示",
			html:msg,
			modal:true,
			static:true,
			onOk:callback
		});
	}
}


/*
    http://www.JSON.org/json2.js
    2010-11-17

    Public Domain.

    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.

    See http://www.JSON.org/js.html


    This code should be minified before deployment.
    See http://javascript.crockford.com/jsmin.html

    USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO
    NOT CONTROL.


    This file creates a global JSON object containing two methods: stringify
    and parse.

        JSON.stringify(value, replacer, space)
            value       any JavaScript value, usually an object or array.

            replacer    an optional parameter that determines how object
                        values are stringified for objects. It can be a
                        function or an array of strings.

            space       an optional parameter that specifies the indentation
                        of nested structures. If it is omitted, the text will
                        be packed without extra whitespace. If it is a number,
                        it will specify the number of spaces to indent at each
                        level. If it is a string (such as '\t' or '&nbsp;'),
                        it contains the characters used to indent at each level.

            This method produces a JSON text from a JavaScript value.

            When an object value is found, if the object contains a toJSON
            method, its toJSON method will be called and the result will be
            stringified. A toJSON method does not serialize: it returns the
            value represented by the name/value pair that should be serialized,
            or undefined if nothing should be serialized. The toJSON method
            will be passed the key associated with the value, and this will be
            bound to the value

            For example, this would serialize Dates as ISO strings.

                Date.prototype.toJSON = function (key) {
                    function f(n) {
                        // Format integers to have at least two digits.
                        return n < 10 ? '0' + n : n;
                    }

                    return this.getUTCFullYear()   + '-' +
                         f(this.getUTCMonth() + 1) + '-' +
                         f(this.getUTCDate())      + 'T' +
                         f(this.getUTCHours())     + ':' +
                         f(this.getUTCMinutes())   + ':' +
                         f(this.getUTCSeconds())   + 'Z';
                };

            You can provide an optional replacer method. It will be passed the
            key and value of each member, with this bound to the containing
            object. The value that is returned from your method will be
            serialized. If your method returns undefined, then the member will
            be excluded from the serialization.

            If the replacer parameter is an array of strings, then it will be
            used to select the members to be serialized. It filters the results
            such that only members with keys listed in the replacer array are
            stringified.

            Values that do not have JSON representations, such as undefined or
            functions, will not be serialized. Such values in objects will be
            dropped; in arrays they will be replaced with null. You can use
            a replacer function to replace those with JSON values.
            JSON.stringify(undefined) returns undefined.

            The optional space parameter produces a stringification of the
            value that is filled with line breaks and indentation to make it
            easier to read.

            If the space parameter is a non-empty string, then that string will
            be used for indentation. If the space parameter is a number, then
            the indentation will be that many spaces.

            Example:

            text = JSON.stringify(['e', {pluribus: 'unum'}]);
            // text is '["e",{"pluribus":"unum"}]'


            text = JSON.stringify(['e', {pluribus: 'unum'}], null, '\t');
            // text is '[\n\t"e",\n\t{\n\t\t"pluribus": "unum"\n\t}\n]'

            text = JSON.stringify([new Date()], function (key, value) {
                return this[key] instanceof Date ?
                    'Date(' + this[key] + ')' : value;
            });
            // text is '["Date(---current time---)"]'


        JSON.parse(text, reviver)
            This method parses a JSON text to produce an object or array.
            It can throw a SyntaxError exception.

            The optional reviver parameter is a function that can filter and
            transform the results. It receives each of the keys and values,
            and its return value is used instead of the original value.
            If it returns what it received, then the structure is not modified.
            If it returns undefined then the member is deleted.

            Example:

            // Parse the text. Values that look like ISO date strings will
            // be converted to Date objects.

            myData = JSON.parse(text, function (key, value) {
                var a;
                if (typeof value === 'string') {
                    a =
/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(value);
                    if (a) {
                        return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4],
                            +a[5], +a[6]));
                    }
                }
                return value;
            });

            myData = JSON.parse('["Date(09/09/2001)"]', function (key, value) {
                var d;
                if (typeof value === 'string' &&
                        value.slice(0, 5) === 'Date(' &&
                        value.slice(-1) === ')') {
                    d = new Date(value.slice(5, -1));
                    if (d) {
                        return d;
                    }
                }
                return value;
            });


    This is a reference implementation. You are free to copy, modify, or
    redistribute.
*/

/*jslint evil: true, strict: false, regexp: false */

/*members "", "\b", "\t", "\n", "\f", "\r", "\"", JSON, "\\", apply,
    call, charCodeAt, getUTCDate, getUTCFullYear, getUTCHours,
    getUTCMinutes, getUTCMonth, getUTCSeconds, hasOwnProperty, join,
    lastIndex, length, parse, prototype, push, replace, slice, stringify,
    test, toJSON, toString, valueOf
*/


// Create a JSON object only if one does not already exist. We create the
// methods in a closure to avoid creating global variables.

if (!this.JSON) {
    this.JSON = {};
}

(function () {
    "use strict";

    function f(n) {
        // Format integers to have at least two digits.
        return n < 10 ? '0' + n : n;
    }

    if (typeof Date.prototype.toJSON !== 'function') {

        Date.prototype.toJSON = function (key) {

            return isFinite(this.valueOf()) ?
                   this.getUTCFullYear()   + '-' +
                 f(this.getUTCMonth() + 1) + '-' +
                 f(this.getUTCDate())      + 'T' +
                 f(this.getUTCHours())     + ':' +
                 f(this.getUTCMinutes())   + ':' +
                 f(this.getUTCSeconds())   + 'Z' : null;
        };

        String.prototype.toJSON =
        Number.prototype.toJSON =
        Boolean.prototype.toJSON = function (key) {
            return this.valueOf();
        };
    }

    var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        gap,
        indent,
        meta = {    // table of character substitutions
            '\b': '\\b',
            '\t': '\\t',
            '\n': '\\n',
            '\f': '\\f',
            '\r': '\\r',
            '"' : '\\"',
            '\\': '\\\\'
        },
        rep;


    function quote(string) {

// If the string contains no control characters, no quote characters, and no
// backslash characters, then we can safely slap some quotes around it.
// Otherwise we must also replace the offending characters with safe escape
// sequences.

        escapable.lastIndex = 0;
        return escapable.test(string) ?
            '"' + string.replace(escapable, function (a) {
                var c = meta[a];
                return typeof c === 'string' ? c :
                    '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
            }) + '"' :
            '"' + string + '"';
    }


    function str(key, holder) {

// Produce a string from holder[key].

        var i,          // The loop counter.
            k,          // The member key.
            v,          // The member value.
            length,
            mind = gap,
            partial,
            value = holder[key];

// If the value has a toJSON method, call it to obtain a replacement value.

        if (value && typeof value === 'object' &&
                typeof value.toJSON === 'function') {
            value = value.toJSON(key);
        }

// If we were called with a replacer function, then call the replacer to
// obtain a replacement value.

        if (typeof rep === 'function') {
            value = rep.call(holder, key, value);
        }

// What happens next depends on the value's type.

        switch (typeof value) {
        case 'string':
            return quote(value);

        case 'number':

// JSON numbers must be finite. Encode non-finite numbers as null.

            return isFinite(value) ? String(value) : 'null';

        case 'boolean':
        case 'null':

// If the value is a boolean or null, convert it to a string. Note:
// typeof null does not produce 'null'. The case is included here in
// the remote chance that this gets fixed someday.

            return String(value);

// If the type is 'object', we might be dealing with an object or an array or
// null.

        case 'object':

// Due to a specification blunder in ECMAScript, typeof null is 'object',
// so watch out for that case.

            if (!value) {
                return 'null';
            }

// Make an array to hold the partial results of stringifying this object value.

            gap += indent;
            partial = [];

// Is the value an array?

            if (Object.prototype.toString.apply(value) === '[object Array]') {

// The value is an array. Stringify every element. Use null as a placeholder
// for non-JSON values.

                length = value.length;
                for (i = 0; i < length; i += 1) {
                    partial[i] = str(i, value) || 'null';
                }

// Join all of the elements together, separated with commas, and wrap them in
// brackets.

                v = partial.length === 0 ? '[]' :
                    gap ? '[\n' + gap +
                            partial.join(',\n' + gap) + '\n' +
                                mind + ']' :
                          '[' + partial.join(',') + ']';
                gap = mind;
                return v;
            }

// If the replacer is an array, use it to select the members to be stringified.

            if (rep && typeof rep === 'object') {
                length = rep.length;
                for (i = 0; i < length; i += 1) {
                    k = rep[i];
                    if (typeof k === 'string') {
                        v = str(k, value);
                        if (v) {
                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
                        }
                    }
                }
            } else {

// Otherwise, iterate through all of the keys in the object.

                for (k in value) {
                    if (Object.hasOwnProperty.call(value, k)) {
                        v = str(k, value);
                        if (v) {
                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
                        }
                    }
                }
            }

// Join all of the member texts together, separated with commas,
// and wrap them in braces.

            v = partial.length === 0 ? '{}' :
                gap ? '{\n' + gap + partial.join(',\n' + gap) + '\n' +
                        mind + '}' : '{' + partial.join(',') + '}';
            gap = mind;
            return v;
        }
    }

// If the JSON object does not yet have a stringify method, give it one.

    if (typeof JSON.stringify !== 'function') {
        JSON.stringify = function (value, replacer, space) {

// The stringify method takes a value and an optional replacer, and an optional
// space parameter, and returns a JSON text. The replacer can be a function
// that can replace values, or an array of strings that will select the keys.
// A default replacer method can be provided. Use of the space parameter can
// produce text that is more easily readable.

            var i;
            gap = '';
            indent = '';

// If the space parameter is a number, make an indent string containing that
// many spaces.

            if (typeof space === 'number') {
                for (i = 0; i < space; i += 1) {
                    indent += ' ';
                }

// If the space parameter is a string, it will be used as the indent string.

            } else if (typeof space === 'string') {
                indent = space;
            }

// If there is a replacer, it must be a function or an array.
// Otherwise, throw an error.

            rep = replacer;
            if (replacer && typeof replacer !== 'function' &&
                    (typeof replacer !== 'object' ||
                     typeof replacer.length !== 'number')) {
                throw new Error('JSON.stringify');
            }

// Make a fake root object containing our value under the key of ''.
// Return the result of stringifying the value.

            return str('', {'': value});
        };
    }


// If the JSON object does not yet have a parse method, give it one.

    if (typeof JSON.parse !== 'function') {
        JSON.parse = function (text, reviver) {

// The parse method takes a text and an optional reviver function, and returns
// a JavaScript value if the text is a valid JSON text.

            var j;

            function walk(holder, key) {

// The walk method is used to recursively walk the resulting structure so
// that modifications can be made.

                var k, v, value = holder[key];
                if (value && typeof value === 'object') {
                    for (k in value) {
                        if (Object.hasOwnProperty.call(value, k)) {
                            v = walk(value, k);
                            if (v !== undefined) {
                                value[k] = v;
                            } else {
                                delete value[k];
                            }
                        }
                    }
                }
                return reviver.call(holder, key, value);
            }


// Parsing happens in four stages. In the first stage, we replace certain
// Unicode characters with escape sequences. JavaScript handles many characters
// incorrectly, either silently deleting them, or treating them as line endings.

            text = String(text);
            cx.lastIndex = 0;
            if (cx.test(text)) {
                text = text.replace(cx, function (a) {
                    return '\\u' +
                        ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
                });
            }

// In the second stage, we run the text against regular expressions that look
// for non-JSON patterns. We are especially concerned with '()' and 'new'
// because they can cause invocation, and '=' because it can cause mutation.
// But just to be safe, we want to reject all unexpected forms.

// We split the second stage into 4 regexp operations in order to work around
// crippling inefficiencies in IE's and Safari's regexp engines. First we
// replace the JSON backslash pairs with '@' (a non-JSON character). Second, we
// replace all simple value tokens with ']' characters. Third, we delete all
// open brackets that follow a colon or comma or that begin the text. Finally,
// we look to see that the remaining characters are only whitespace or ']' or
// ',' or ':' or '{' or '}'. If that is so, then the text is safe for eval.

            if (/^[\],:{}\s]*$/
.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@')
.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']')
.replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {

// In the third stage we use the eval function to compile the text into a
// JavaScript structure. The '{' operator is subject to a syntactic ambiguity
// in JavaScript: it can begin a block or an object literal. We wrap the text
// in parens to eliminate the ambiguity.

                j = eval('(' + text + ')');

// In the optional fourth stage, we recursively walk the new structure, passing
// each name/value pair to a reviver function for possible transformation.

                return typeof reviver === 'function' ?
                    walk({'': j}, '') : j;
            }

// If the text is not JSON parseable, then a SyntaxError is thrown.

            throw new SyntaxError('JSON.parse');
        };
    }
}());

