package com.ccclubs.action.api.webservice;

import java.net.URL;

import org.codehaus.xfire.client.Client;

import com.lazy3q.web.helper.$;

/**
 * 计划任务加载器
 * 
 * @author zhangjian
 *
 */
public class ScheduleTaskLoader{
	
	ICarStateService carStateService;
	
	/**
	 * 调用凭据
	 */
	final ApiSecretKey apiKey = new ApiSecretKey("http://116.6.66.86/xs/DataReceiver.asmx?WSDL", "AE14", "17A6A33116D9");	
	
	/**
	 * 初始化
	 */
	public void init(){
		startUploadCarRent();
		startUploadOutlets();
	}
	
	/**
	 * 启动上传车辆租赁
	 */
	protected void startUploadCarRent(){
		final java.util.Timer timer = new java.util.Timer(false);  
		java.util.TimerTask task = new java.util.TimerTask(){  
				@Override  
				public void run() {  
					if($.empty($.config("release.online"))){
						$.trace("非在线模式，放弃执行当前任务: startUploadCarRent");
					}else{
						try{
							String data = carStateService.getCarRentData();
							System.out.print("send carRentData:\t");
							uploadData(data);
						}catch(Exception e){
							e.printStackTrace();
						}
					}
		        }
		};  
        long delay = 10000;			//从接收到指令延迟十秒后开始执行  
        long period = 1000*60;  	//频率：一分钟每次
        //启动定时任务，立即执行壹次，然后每隔两秒执行壹次  
        timer.schedule(task, delay, period);  
	}
	
	/**
	 * 启动上传租赁点
	 */
	protected void startUploadOutlets(){
		final java.util.Timer timer = new java.util.Timer(false);  
		java.util.TimerTask task = new java.util.TimerTask(){  
			@Override  
			public void run() {  
				if($.empty($.config("release.online"))){
					$.trace("非在线模式，放弃执行当前任务: startUploadOutlets");
				}else{
					try{
						String data = carStateService.getOutletsData();
						System.out.print("send outletsData:\t");
						uploadData(data);
					}catch(Exception e){
						e.printStackTrace();
					}
				}
			}
		};  
		long delay = 10000;			//从接收到指令延迟十秒后开始执行  
        //long period = 1000*60;  	//频率：一分钟每次
        long period = 1000*60*60;  	//频率：一小时每次
		//启动定时任务，立即执行壹次，然后每隔两秒执行壹次  
		timer.schedule(task, delay, period);
	}
	
	/**
	 * 上传数据
	 * @param data
	 */
	public void uploadData(Object data){
		try {
			Client client = new Client(new URL(apiKey.getUrl()));
			Object[] object = client.invoke("uploadPacketData", new Object[]{apiKey.getUserName(), apiKey.getPassword(), data});
			String packetData = (String) object[0];
			if(packetData !=null && packetData.contains("OK") || packetData.contains("ok")){
				System.out.println(packetData);
			}else{
				System.out.println("数据上传异常： "+data);
				uploadData(data);
			}
//			$.trace("获取到数据包",packetData.length());
		} catch (Exception e) {
			e.printStackTrace();
			uploadData(data);
		}
	}
	
	public static void main(String[] args) {
//		String rent_data = "23230AFE7A6B6277313233343536373839303132330000180E0B060A0C32030E0B060A0C320E0B060A0C320100000000EC";
//		String rent_data1 = "23230AFE4C4E4253434233463245443134303630310000180E0B060A3423010000000000000000000000000300000000A6|23230AFE4C4E4253434233463145443134303635340000180E0B060A3423030E0A1F0E0A000E0B050F0A000300000000BD|23230AFE4C4E4253434233463845443134303236330000180E0B060A3423010000000000000000000000000300000000AC|23230AFE4C4E4253434233463845443134303237370000180E0B060A3423010000000000000000000000000300000000A9|23230AFE4C4E4253434233463845443134303139360000180E0B060A3423010000000000000000000000000300000000A5|23230AFE4C4E4253434233463145443134303734390000180E0B060A3423010000000000000000000000000300000000A8|23230AFE4C4E4253434233463745443134303733380000180E0B060A3423010000000000000000000000000300000000A8|23230AFE4C4E4253434233463745443134303630390000180E0B060A3423010000000000000000000000000300000000AB|23230AFE4C4E4253434233463145443134303733350000180E0B060A3423010000000000000000000000000300000000A3|23230AFE4C4E4253434233463045443134303631340000180E0B060A3423010000000000000000000000000300000000A0|23230AFE4C4E4253434233463845443134303636360000180E0B060A3423010000000000000000000000000300000000AD|23230AFE4C4E4253434233463445443134303733310000180E0B060A3423030E0B020900000E0B040900000300000000A6|23230AFE4C4E4253434233465845443134303732300000180E0B060A3423010000000000000000000000000300000000CE|23230AFE4C4E4253434233463945443134303731310000180E0B060A3423010000000000000000000000000300000000AD|23230AFE4C4E4253434233463545443134303638370000180E0B060A3423010000000000000000000000000300000000AF|23230AFE4C4E4253434233463845443134303638330000180E0B060A3423010000000000000000000000000300000000A6|23230AFE4C4E4253434233463445443134303639350000180E0B060A3423010000000000000000000000000300000000AD|23230AFE4C4E4253434233463145443134303638350000180E0B060A3423030E0B031200000E0B041200000300000000AC|23230AFE4C4E4253434233465845443134303731370000180E0B060A3423010000000000000000000000000300000000CA|23230AFE4C4E4253434233463045443134303732360000180E0B060A3423030E0A1F0C1E000E0B051100000300000000BA|23230AFE4C4E4253434233463445443134303732380000180E0B060A3423030E0B040828000E0B041128000300000000B1|23230AFE4C4E4253434233463445443134303638310000180E0B060A3423010000000000000000000000000300000000A8|23230AFE4C4E4253434233463645443134303638320000180E0B060A3423010000000000000000000000000300000000A9|23230AFE4C4E4253434233463445443134303237350000180E0B060A3423010000000000000000000000000300000000A7|23230AFE4C4E4253434233463845443134303337350000180E0B060A3423010000000000000000000000000300000000AA|23230AFE4C4E4253434233463945443134303434380000180E0B060A3423010000000000000000000000000300000000A2|23230AFE4C4E4253434233463345443134303435390000180E0B060A3423010000000000000000000000000300000000A8|23230AFE4C4E4253434233463345443134303735330000180E0B060A3423010000000000000000000000000300000000A1|23230AFE4C4E4253434233463845443134303736340000180E0B060A3423010000000000000000000000000300000000AE|23230AFE4C4E4253434233463445443134303337330000180E0B060A3423010000000000000000000000000300000000A0|23230AFE4C4E4253434233463845443134303737380000180E0B060A3423010000000000000000000000000300000000A3|23230AFE4C4E4253434233463845443134303434320000180E0B060A3423010000000000000000000000000300000000A9|23230AFE4C4E4253434233463945443134303138380000180E0B060A3423010000000000000000000000000300000000AB|23230AFE4C4E4253434233463345443134303537340000180E0B060A3423010000000000000000000000000300000000A6|23230AFE4C4E4253434233463945443134303139310000180E0B060A3423010000000000000000000000000300000000A3|23230AFE4C4E4253434233465845443134303332380000180E0B060A3423010000000000000000000000000300000000C2|23230AFE4C4E4253434233465845443134303832390000180E0B060A3423010000000000000000000000000300000000C8|23230AFE4C4E4253434233465845443134303833320000180E0B060A3423010000000000000000000000000300000000C2|23230AFE4C4E4253434233465845443134303236340000180E0B060A3423010000000000000000000000000300000000CB|23230AFE4C4E4253434233465845443134303533380000180E0B060A3423010000000000000000000000000300000000C5|23230AFE4C4E4253434233465845443134303139370000180E0B060A3423010000000000000000000000000300000000C4|23230AFE4C4E4253434233465845443134303439310000180E0B060A3423010000000000000000000000000300000000C7|23230AFE4C4E4253434233465845443134303037310000180E0B060A3423010000000000000000000000000300000000CD|23230AFE4C4E4253434233465845443134303737390000180E0B060A3423010000000000000000000000000300000000C2|23230AFE4C4E4253434233465845443134303330300000180E0B060A3423010000000000000000000000000300000000C8|23230AFE4C4E4253434233463945443134303335330000180E0B060A3423010000000000000000000000000300000000AF";
//		String outlets_data = "23230CFE7A6B62773132333435363738393031323300005E0E0B060F1A0AA1BD280739D8CD01000000000000030000000000000000000102BEA9413036303431BEA94130363034320000000000000000000201BEA94130363034330000000000000000000301BEA941303630343400000000000000009E";
//		String outlets_data1 = "23230CFE00000000000000000000000000000000000000680E0B060F38178CDBF10621075F02B1B1BEA9BAE3012020202020203130303848424A514C335A3830424A514C30593139424A514C30593535424A514C30593138424A514C305A3639424A513430343539424A514C30593131424A514C305A3638424A514C39593732424A514C305A3237424A514C39593730424A514C30593130424A514739473231424A514C325A3331424A513430373738424A513430313931424A513430383332424A514738473933424A514C335A3335424A514C30593830424A514C30593831424A514C305A3333424A514737473231424A513430353734424A513430343438424A514C30593035424A514739473835424A514C305A3736424A515445535443424A513430343432424A514C305A37392020202020202030424A514739473331424A513430313838424A514C305A3339424A513430383239424A513430373634424A514C335A3031424A515445535442424A515445535441424A514836483137424A514C30593739424A514C335A3637424A515445535439424A515445535438424A515445535437424A514737473533424A515445535436424A514C30593732424A515445535435424A515445535434424A513430323735424A513430333735424A514C325A3537424A514C35593733424A513430373533424A514837483038424A513430333238424A514C355A3030424A515445535431424A514C30593638424A514C305A3538424A514739473137424A514C39593337424A514837483035424A514C335A3939424A514C335A3938424A514C30593237424A513430323634424A514C30593239424A514C305A3535424A514C355A303800000000000000006A";
		String rent_data = "23230AFE4C4E4253434233463245443134303630310000180E0B070F0003010000000000000000000000000300000000B6|23230AFE4C4E4253434233463145443134303635340000180E0B070F0003030E0A1F0E0A000E0B050F0A000300000000AD|23230AFE4C4E4253434233463845443134303236330000180E0B070F0003010000000000000000000000000300000000BC|23230AFE4C4E4253434233463845443134303237370000180E0B070F0003010000000000000000000000000300000000B9|23230AFE4C4E4253434233463845443134303139360000180E0B070F0003010000000000000000000000000300000000B5|23230AFE4C4E4253434233463145443134303734390000180E0B070F0003010000000000000000000000000300000000B8|23230AFE4C4E4253434233463745443134303733380000180E0B070F0003010000000000000000000000000300000000B8|23230AFE4C4E4253434233463745443134303630390000180E0B070F0003010000000000000000000000000300000000BB|23230AFE4C4E4253434233463145443134303733350000180E0B070F0003010000000000000000000000000300000000B3|23230AFE4C4E4253434233463045443134303631340000180E0B070F0003010000000000000000000000000300000000B0|23230AFE4C4E4253434233463845443134303636360000180E0B070F0003010000000000000000000000000300000000BD|23230AFE4C4E4253434233463445443134303733310000180E0B070F0003030E0B020900000E0B040900000300000000B6|23230AFE4C4E4253434233465845443134303732300000180E0B070F0003010000000000000000000000000300000000DE|23230AFE4C4E4253434233463945443134303731310000180E0B070F0003010000000000000000000000000300000000BD|23230AFE4C4E4253434233463545443134303638370000180E0B070F0003010000000000000000000000000300000000BF|23230AFE4C4E4253434233463845443134303638330000180E0B070F0003010000000000000000000000000300000000B6|23230AFE4C4E4253434233463445443134303639350000180E0B070F0003010000000000000000000000000300000000BD|23230AFE4C4E4253434233463145443134303638350000180E0B070F0003030E0B031200000E0B041200000300000000BC|23230AFE4C4E4253434233465845443134303731370000180E0B070F0003010000000000000000000000000300000000DA|23230AFE4C4E4253434233463045443134303732360000180E0B070F0003030E0A1F0C1E000E0B051100000300000000AA|23230AFE4C4E4253434233463445443134303732380000180E0B070F0003030E0B040828000E0B041128000300000000A1|23230AFE4C4E4253434233463445443134303638310000180E0B070F0003010000000000000000000000000300000000B8|23230AFE4C4E4253434233463645443134303638320000180E0B070F0003010000000000000000000000000300000000B9|23230AFE4C4E4253434233463445443134303237350000180E0B070F0003010000000000000000000000000300000000B7|23230AFE4C4E4253434233463845443134303337350000180E0B070F0003010000000000000000000000000300000000BA|23230AFE4C4E4253434233463945443134303434380000180E0B070F0003010000000000000000000000000300000000B2|23230AFE4C4E4253434233463345443134303435390000180E0B070F0003010000000000000000000000000300000000B8|23230AFE4C4E4253434233463345443134303735330000180E0B070F0003010000000000000000000000000300000000B1|23230AFE4C4E4253434233463845443134303736340000180E0B070F0003010000000000000000000000000300000000BE|23230AFE4C4E4253434233463445443134303337330000180E0B070F0003010000000000000000000000000300000000B0|23230AFE4C4E4253434233463845443134303737380000180E0B070F0003010000000000000000000000000300000000B3|23230AFE4C4E4253434233463845443134303434320000180E0B070F0003010000000000000000000000000300000000B9|23230AFE4C4E4253434233463945443134303138380000180E0B070F0003010000000000000000000000000300000000BB|23230AFE4C4E4253434233463345443134303537340000180E0B070F0003010000000000000000000000000300000000B6|23230AFE4C4E4253434233463945443134303139310000180E0B070F0003010000000000000000000000000300000000B3|23230AFE4C4E4253434233465845443134303332380000180E0B070F0003010000000000000000000000000300000000D2|23230AFE4C4E4253434233465845443134303832390000180E0B070F0003010000000000000000000000000300000000D8|23230AFE4C4E4253434233465845443134303833320000180E0B070F0003010000000000000000000000000300000000D2|23230AFE4C4E4253434233465845443134303236340000180E0B070F0003010000000000000000000000000300000000DB|23230AFE4C4E4253434233465845443134303533380000180E0B070F0003010000000000000000000000000300000000D5|23230AFE4C4E4253434233465845443134303139370000180E0B070F0003010000000000000000000000000300000000D4|23230AFE4C4E4253434233465845443134303439310000180E0B070F0003010000000000000000000000000300000000D7|23230AFE4C4E4253434233465845443134303037310000180E0B070F0003010000000000000000000000000300000000DD|23230AFE4C4E4253434233465845443134303737390000180E0B070F0003010000000000000000000000000300000000D2|23230AFE4C4E4253434233465845443134303330300000180E0B070F0003010000000000000000000000000300000000D8|23230AFE4C4E4253434233463945443134303335330000180E0B070F0003010000000000000000000000000300000000BF";
//		String outlets_data = "23230CFE00000000000000000000000000000000000000680E0B070F1B228CDBF10621075F02B1B1BEA9BAE3012020202020203130303848424A514C335A3830424A514C30593139424A514C30593535424A514C30593138424A514C305A3639424A513430343539424A514C30593131424A514C305A3638424A514C39593732424A514C305A3237424A514C39593730424A514C30593130424A514739473231424A514C325A3331424A513430373738424A513430313931424A513430383332424A514738473933424A514C335A3335424A514C30593830424A514C30593831424A514C305A3333424A514737473231424A513430353734424A513430343438424A514C30593035424A514739473835424A514C305A3736424A515445535443424A513430343432424A514C305A37392020202020202030424A514739473331424A513430313838424A514C305A3339424A513430383239424A513430373634424A514C335A3031424A515445535442424A515445535441424A514836483137424A514C30593739424A514C335A3637424A515445535439424A515445535438424A515445535437424A514737473533424A515445535436424A514C30593732424A515445535435424A515445535434424A513430323735424A513430333735424A514C325A3537424A514C35593733424A513430373533424A514837483038424A513430333238424A514C355A3030424A515445535431424A514C30593638424A514C305A3538424A514739473137424A514C39593337424A514837483035424A514C335A3939424A514C335A3938424A514C30593237424A513430323634424A514C30593239424A514C305A3535424A514C355A303800000000000000007D";
		String outlets_data = "23230CFE00000000000000000000000000000000000000690E0B0A12131506F1DB8C025F0721424A4859202001202020202020313030380048424A514C335A3830424A514C30593139424A514C30593535424A514C30593138424A514C305A3639424A513430343539424A514C30593131424A514C305A3638424A514C39593732424A514C305A3237424A514C39593730424A514C30593130424A514739473231424A514C325A3331424A513430373738424A513430313931424A513430383332424A514738473933424A514C335A3335424A514C30593830424A514C30593831424A514C305A3333424A514737473231424A513430353734424A513430343438424A514C30593035424A514739473835424A514C305A3736424A515445535443424A513430343432424A514C305A37392020202020202030424A514739473331424A513430313838424A514C305A3339424A513430383239424A513430373634424A514C335A3031424A515445535442424A515445535441424A514836483137424A514C30593739424A514C335A3637424A515445535439424A515445535438424A515445535437424A514737473533424A515445535436424A514C30593732424A515445535435424A515445535434424A513430323735424A513430333735424A514C325A3537424A514C35593733424A513430373533424A514837483038424A513430333238424A514C355A3030424A515445535431424A514C30593638424A514C305A3538424A514739473137424A514C39593337424A514837483035424A514C335A3939424A514C335A3938424A514C30593237424A513430323634424A514C30593239424A514C305A3535424A514C355A3038000000000000000004";
		new ScheduleTaskLoader().uploadData(outlets_data);
	}

	public ICarStateService getCarStateService() {
		return carStateService;
	}

	public void setCarStateService(ICarStateService carStateService) {
		this.carStateService = carStateService;
	}
}
